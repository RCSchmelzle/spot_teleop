Goal: ORbslam3 with offline atlas/map reconciliation to determine extrinsic Processing


cd ~/Projects/teleoperation_spot/system_ws/src

# Clone the wrapper
git clone https://github.com/zang09/ORB_SLAM3_ROS2.git orbslam3_ros2

cd ~
git clone https://github.com/UZ-SLAMLab/ORB_SLAM3.git
cd ORB_SLAM3
# follow their build instructions (Eigen, Pangolin, OpenCV)

cd ~/Projects/teleoperation_spot/system_ws
source /opt/ros/jazzy/setup.bash

colcon build --symlink-install --packages-select orbslam3


sudo apt update
sudo apt install python3-ament-package
sudo apt install python3-pip -y   # if you don't already have pip

python3 -m pip install --user ament-package
python3 -m pip install --user --break-system-packages ament-package
python3 -c "import ament_package; print(ament_package.__file__)"


cd ~/Projects/teleoperation_spot/system_ws
source /opt/ros/jazzy/setup.bash

colcon build --symlink-install --packages-select orbslam3
cd ~/Projects/teleoperation_spot/system_ws

# 1. Source ROS 2 Jazzy
source /opt/ros/jazzy/setup.bash

# 2. Explicitly add ROS Python packages to PYTHONPATH
export PYTHONPATH=/opt/ros/jazzy/lib/python3.12/site-packages:$PYTHONPATH

# 3. Sanity check that THIS python sees ament_package
/usr/bin/python3 -c "import ament_package; print(ament_package.__file__)"



/usr/bin/python3 -c "import ament_package; print(ament_package.__file__)"
# /opt/ros/jazzy/lib/python3.12/site-packages/ament_package/__init__.py


cd ~
git clone https://github.com/strasdat/Sophus.git
cd Sophus

mkdir build && cd build
cmake .. -DCMAKE_BUILD_TYPE=Release
make -j$(nproc)
sudo make install


export CMAKE_PREFIX_PATH=/usr/local:$CMAKE_PREFIX_PATH


Great, this is actually good news: the nasty `ament_package` issue is gone and we’re now at a **normal dependency error**:

```text
CMake Error at CMakeLists.txt:23 (find_package):
  ...
  Could not find a package configuration file provided by "Sophus"
```

So:

* ✅ Your ROS2 / ament setup is now fine.
* ❌ The **zang09 ORB_SLAM3_ROS2** package wants **Sophus** installed on the host.
* And yes, all of this is **on the host**, not in the old Docker.

I’ll answer your “why Docker vs host?” first, then give you concrete next steps to get to **live ORB-SLAM3 in ROS2**, no bag conversion.

---

## 1. Why did we use Docker before, and do we still need it?

* ORB-SLAM3 is just C++ — it’s not fundamentally incompatible with Ubuntu 24.04 + ROS2 Jazzy.
* But its **dependency stack** (Eigen, Pangolin, OpenCV, Sophus) is annoying and was originally documented for Ubuntu 20.04 / ROS1.
* Earlier, when you were on **ROS1 / Noetic** and not yet on ROS2, we put ORB-SLAM3 into a **Noetic Docker** to:

  * avoid polluting your host with old libs,
  * have a “known good” environment to test datasets.

Now you’re on **ROS2 Jazzy**, and you want **live ORB-SLAM3 inside ROS2**. For that, we *do* need a **ROS2-native build** (or a ROS2 ORB-SLAM3 Docker that talks DDS to your host). That’s why we’re now wrestling with `orbslam3` as a ROS2 package on the host.

So:

* You still **can** keep using the old Docker for ROS1 / offline experiments.
* For **live ROS2** with Xtions, we’re now going for a **native ROS2 wrapper** on the host.

Totally reasonable.

---

## 2. Where we are with the ROS2 wrapper (host)

We cloned **zang09/ORB_SLAM3_ROS2** and tried to build the `orbslam3` package. Now:

* `ament_package` is fixed ✅
* CMake is failing because **Sophus** is missing ❌

So the next steps in this path are:

1. Install **Sophus** on the host.
2. Build **ORB_SLAM3** itself on the host (in `~/ORB_SLAM3`).
3. Rebuild the ROS2 `orbslam3` wrapper.
4. Run the `rgbd` node and feed it your **live topics or bag**.

You said you **don’t want TUM conversion**, you want **live ORB-SLAM3** — this path *does* give you that.

---

## 3. Install Sophus (host, Ubuntu 24.04)

On the host:

```bash
cd ~
git clone https://github.com/strasdat/Sophus.git
cd Sophus

mkdir build && cd build
cmake .. -DCMAKE_BUILD_TYPE=Release
make -j$(nproc)
sudo make install
```

This installs:

* headers under `/usr/local/include/Sophus`
* CMake config under `/usr/local/lib/cmake/Sophus` (or similar)

So CMake can find `SophusConfig.cmake`.

If needed:

```bash
export CMAKE_PREFIX_PATH=/usr/local:$CMAKE_PREFIX_PATH
```

(You can put that in your shell before calling `colcon build`.)

---

## 4. Build ORB_SLAM3 on the host

Right now `~/ORB_SLAM3` is just cloned, not built.

Follow the **official ORB_SLAM3 build instructions** there (host side):

```bash
cd ~/ORB_SLAM3

# Install deps (if not already installed)
sudo apt install \
  libeigen3-dev \
  libsuitesparse-dev \
  libboost-all-dev \
  libopencv-dev \
  cmake build-essential

# Pangolin: either from apt or from source
# (apt version might be good enough on 24.04)
sudo apt install libglew-dev libxkbcommon-dev
git clone https://github.com/stevenlovegrove/Pangolin.git
cd Pangolin
mkdir build && cd build
cmake .. -DCMAKE_BUILD_TYPE=Release
make -j$(nproc)
sudo make install

# Back to ORB_SLAM3
cd ~/ORB_SLAM3
mkdir build && cd build
cmake .. -DCMAKE_BUILD_TYPE=Release
make -j$(nproc)
```

If that finishes without error, you now have:

* A host build of **ORB_SLAM3** (library + examples).
* System-wide **Sophus** and **Pangolin**.

This is exactly what the ROS2 wrapper expects.

---

## 5. Rebuild the ROS2 `orbslam3` package

Now go back to your ROS2 workspace:

```bash
cd ~/Projects/teleoperation_spot/system_ws
source /opt/ros/jazzy/setup.bash

# Ensure CMake can see /usr/local where Sophus and Pangolin went
export CMAKE_PREFIX_PATH=/usr/local:$CMAKE_PREFIX_PATH

colcon build --symlink-install --packages-select orbslam3
```

If `ORB_SLAM3_ROS2` is configured correctly, it should now:

* Find Sophus
* Link against your `~/ORB_SLAM3` build
* Produce the `rgbd` node and friends

If you get a new error at this stage, it will be about some other dep (OpenCV version, Pangolin, etc.) — which we can tackle one by one, but **Sophus will be solved**.

---

## 6. Once it builds: live ORB-SLAM3 on your Xtion topics

When the `orbslam3` package finally builds:

1. Make a camera config (YAML) for Xtion RGB-D (intrinsics, resolution, depth scale), e.g.:

   ```bash
   ~/Projects/teleoperation_spot/system_ws/src/orbslam3_ros2/config/xtion_rgbd/xtion_camA.yaml
   ```

2. Start ORB-SLAM3 RGB-D for `camA`:

   ```bash
   cd ~/Projects/teleoperation_spot/system_ws
   source /opt/ros/jazzy/setup.bash
   source install/setup.bash

   ros2 run orbslam3 rgbd \
     src/orbslam3_ros2/vocabulary/ORBvoc.txt \
     src/orbslam3_ros2/config/xtion_rgbd/xtion_camA.yaml \
     --ros-args \
       -r /camera/rgb/image_raw:=/camA/rgb/image_raw \
       -r /camera/depth/image:=/camA/depth_raw/image
   ```

3. For **live** operation:

   * In another terminal, run your Xtion bringup:

     ```bash
     ros2 launch xtion_bringup multi_xtion.launch.py
     ```

   * OR, for **bag playback**:

     ```bash
     ros2 bag play xtion_20251203_154457.bag
     ```

In both cases, ORB-SLAM3 is consuming ROS2 topics **directly**. No TUM conversion, no offline step.

---

## 7. TL;DR

* We used Docker earlier because ORB-SLAM3’s deps were a pain in ROS1-land; it gave us a known-good environment.
* For **live ROS2 on Ubuntu 24.04 Jazzy**, we’re now going for a **native ROS2 wrapper** on the host.
* You’re very close:

  * `ament_package` fixed ✅
  * next: install **Sophus**, build **ORB_SLAM3** host-side, rebuild `orbslam3` package.
* Once `orbslam3` builds, you get exactly what you want:

  * `ros2 run orbslam3 rgbd ...`
  * reading `/camA/...` and `/camB/...` streams **live**, no conversion.

If you want, I can next give you a **minimal `xtion_camA.yaml` example** for ORB-SLAM3 and the exact `ros2 run` command line wired to your topics from the `xtion_20251203_154457.bag`.


export CMAKE_PREFIX_PATH=/usr/local:$CMAKE_PREFIX_PATH



cd ~/Projects/teleoperation_spot/cpp

# If you have ~/ORB_SLAM3 already, you can move it:
mv ~/ORB_SLAM3 ./ORB_SLAM3

# If that fails or you prefer clean:
# git clone https://github.com/UZ-SLAMLab/ORB_SLAM3.git ORB_SLAM3

git clone https://github.com/strasdat/Sophus.git Sophus


cd ~/Projects/teleoperation_spot/cpp/Sophus
mkdir build && cd build

cmake .. \
  -DCMAKE_BUILD_TYPE=Release \
  -DCMAKE_INSTALL_PREFIX=~/Projects/teleoperation_spot/cpp/sophus_install

make -j$(nproc)
make install   # no sudo; installs to your home project



export CMAKE_PREFIX_PATH=~/Projects/teleoperation_spot/cpp/sophus_install:$CMAKE_PREFIX_PATH
export Sophus_DIR=~/Projects/teleoperation_spot/cpp/sophus_install/lib/cmake/Sophus


cd ~/Projects/teleoperation_spot/cpp/ORB_SLAM3
mkdir build && cd build

# Make sure Sophus is visible
export CMAKE_PREFIX_PATH=~/Projects/teleoperation_spot/cpp/sophus_install:$CMAKE_PREFIX_PATH

cmake .. -DCMAKE_BUILD_TYPE=Release
make -j$(nproc)

# 1. Go to ORB_SLAM3 folder and verify CMakeLists.txt is there
cd ~/Projects/teleoperation_spot/cpp/ORB_SLAM3
ls
# you should see: CMakeLists.txt, Examples/, include/, src/, etc.

# 2. Nuke any bad build dir and recreate it fresh
rm -rf build
mkdir build
cd build

# 3. Make sure Sophus install prefix is in CMAKE_PREFIX_PATH
export CMAKE_PREFIX_PATH=~/Projects/teleoperation_spot/cpp/sophus_install:$CMAKE_PREFIX_PATH
export Sophus_DIR=~/Projects/teleoperation_spot/cpp/sophus_install/lib/cmake/Sophus

# 4. Configure and build
cmake .. -DCMAKE_BUILD_TYPE=Release
make -j4


cd ~/Projects/teleoperation_spot/cpp/ORB_SLAM3
grep -Rnl -- '-std=c++11' . | xargs sed -i 's/-std=c++11/-std=c++14/g'

cd ~/Projects/teleoperation_spot/cpp
rm -rf ORB_SLAM3

git clone https://github.com/UZ-SLAMLab/ORB_SLAM3.git ORB_SLAM3


cd ~/Projects/teleoperation_spot/cpp
rm -rf ORB_SLAM3

git clone https://github.com/UZ-SLAMLab/ORB_SLAM3.git ORB_SLAM3



ls ~/Projects/teleoperation_spot/cpp
# expect to see: Sophus/  sophus_install/  ORB_SLAM3/  ...

ls ~/Projects/teleoperation_spot/cpp/sophus_install
# expect something like: include/  lib/  share/  (or at least include/ lib/)

cd ~/Projects/teleoperation_spot/cpp/ORB_SLAM3


grep -Rnl -- '-std=c++11' . | xargs sed -i 's/-std=c++11/-std=c++14/g'


AM3$ cat CMakeLists.txt | grep "11"
# Check C++11 or C++0x support
CHECK_CXX_COMPILER_FLAG("-std=c++14" COMPILER_SUPPORTS_CXX11)
if(COMPILER_SUPPORTS_CXX11)
   add_definitions(-DCOMPILEDWITHC11)
   message(FATAL_ERROR "The compiler ${CMAKE_CXX_COMPILER} has no C++11 support. Please use a different C++ compiler.")
rysch01@rysch01-Legion-Pro-5-2404:~/Projects/teleoperation_spot/cpp/ORB_SLAM3$ 



sed -i '/# Check C++11 or C++0x support/,/endif()/c\
# Check C++14 support\n\
CHECK_CXX_COMPILER_FLAG("-std=c++14" COMPILER_SUPPORTS_CXX14)\n\
if(COMPILER_SUPPORTS_CXX14)\n\
    add_definitions(-DCOMPILEDWITHC14)\n\
else()\n\
    message(FATAL_ERROR "The compiler ${CMAKE_CXX_COMPILER} has no C++14 support. Please use a different C++ compiler.")\n\
endif()' CMakeLists.txt


cd ~/Projects/teleoperation_spot/cpp/ORB_SLAM3
rm -rf build
mkdir build
cd build

export CMAKE_PREFIX_PATH=~/Projects/teleoperation_spot/cpp/sophus_install:$CMAKE_PREFIX_PATH
export Sophus_DIR=~/Projects/teleoperation_spot/cpp/sophus_install/lib/cmake/Sophus

cmake .. -DCMAKE_BUILD_TYPE=Release
make -j1

sed -i '/cmake_minimum_required/a include(CheckCXXCompilerFlag)' CMakeLists.txt


cd ~/Projects/teleoperation_spot/cpp/ORB_SLAM3/Thirdparty/DBoW2
rm -rf build
mkdir build
cd build

cmake .. -DCMAKE_BUILD_TYPE=Release
make -j"$(nproc)"



rysch01@rysch01-Legion-Pro-5-2404:~/Projects/teleoperation_spot/cpp/ORB_SLAM3/build$ cd ~/Projects/teleoperation_spot/cpp/ORB_SLAM3

# See where it's used (for sanity)
grep -R --line-number "monotonic_clock" Examples

# Patch only this symbol in this file
sed -i 's/monotonic_clock/steady_clock/g' Examples/RGB-D/rgbd_tum.cc
Examples/Monocular/mono_tum_vi.cc:118:                std::chrono::monotonic_clock::time_point t_Start_Resize = std::chrono::monotonic_clock::now();
Examples/Monocular/mono_tum_vi.cc:128:                std::chrono::monotonic_clock::time_point t_End_Resize = std::chrono::monotonic_clock::now();
Examples/Monocular/mono_tum_vi.cc:151:            std::chrono::monotonic_clock::time_point t1 = std::chrono::monotonic_clock::now();
Examples/Monocular/mono_tum_vi.cc:160:            std::chrono::monotonic_clock::time_point t2 = std::chrono::monotonic_clock::now();
Examples/Monocular/mono_realsense_t265.cc:122:                std::chrono::monotonic_clock::time_point t_Start_Resize = std::chrono::monotonic_clock::now();
Examples/Monocular/mono_realsense_t265.cc:132:                std::chrono::monotonic_clock::time_point t_End_Resize = std::chrono::monotonic_clock::now();
Examples/Monocular/mono_realsense_t265.cc:147:            std::chrono::monotonic_clock::time_point t1 = std::chrono::monotonic_clock::now();
Examples/Monocular/mono_realsense_t265.cc:158:            std::chrono::monotonic_clock::time_point t2 = std::chrono::monotonic_clock::now();
Examples/Monocular/mono_kitti.cc:84:            std::chrono::monotonic_clock::time_point t_Start_Resize = std::chrono::monotonic_clock::now();
Examples/Monocular/mono_kitti.cc:94:            std::chrono::monotonic_clock::time_point t_End_Resize = std::chrono::monotonic_clock::now();
Examples/Monocular/mono_kitti.cc:104:        std::chrono::monotonic_clock::time_point t1 = std::chrono::monotonic_clock::now();
Examples/Monocular/mono_kitti.cc:113:        std::chrono::monotonic_clock::time_point t2 = std::chrono::monotonic_clock::now();
Examples/Monocular/mono_euroc.cc:115:                std::chrono::monotonic_clock::time_point t_Start_Resize = std::chrono::monotonic_clock::now();
Examples/Monocular/mono_euroc.cc:125:                std::chrono::monotonic_clock::time_point t_End_Resize = std::chrono::monotonic_clock::now();
Examples/Monocular/mono_euroc.cc:135:            std::chrono::monotonic_clock::time_point t1 = std::chrono::monotonic_clock::now();
Examples/Monocular/mono_euroc.cc:145:            std::chrono::monotonic_clock::time_point t2 = std::chrono::monotonic_clock::now();
Examples/Monocular/mono_tum.cc:85:            std::chrono::monotonic_clock::time_point t_Start_Resize = std::chrono::monotonic_clock::now();
Examples/Monocular/mono_tum.cc:95:            std::chrono::monotonic_clock::time_point t_End_Resize = std::chrono::monotonic_clock::now();
Examples/Monocular/mono_tum.cc:105:        std::chrono::monotonic_clock::time_point t1 = std::chrono::monotonic_clock::now();
Examples/Monocular/mono_tum.cc:114:        std::chrono::monotonic_clock::time_point t2 = std::chrono::monotonic_clock::now();
Examples/Monocular/mono_realsense_D435i.cc:234:            std::chrono::monotonic_clock::time_point time_Start_Process = std::chrono::monotonic_clock::now();
Examples/Monocular/mono_realsense_D435i.cc:253:            std::chrono::monotonic_clock::time_point t_Start_Resize = std::chrono::monotonic_clock::now();
Examples/Monocular/mono_realsense_D435i.cc:264:            std::chrono::monotonic_clock::time_point t_End_Resize = std::chrono::monotonic_clock::now();
Examples/Monocular/mono_realsense_D435i.cc:275:        std::chrono::monotonic_clock::time_point t_Start_Track = std::chrono::monotonic_clock::now();
Examples/Monocular/mono_realsense_D435i.cc:284:        std::chrono::monotonic_clock::time_point t_End_Track = std::chrono::monotonic_clock::now();
Examples/Stereo-Inertial/stereo_inertial_realsense_t265.cc:249:                std::chrono::monotonic_clock::time_point t_Start_Resize = std::chrono::monotonic_clock::now();
Examples/Stereo-Inertial/stereo_inertial_realsense_t265.cc:260:                std::chrono::monotonic_clock::time_point t_End_Resize = std::chrono::monotonic_clock::now();
Examples/Stereo-Inertial/stereo_inertial_realsense_t265.cc:300:        std::chrono::monotonic_clock::time_point t_Start_Track = std::chrono::monotonic_clock::now();
Examples/Stereo-Inertial/stereo_inertial_realsense_t265.cc:309:        std::chrono::monotonic_clock::time_point t_End_Track = std::chrono::monotonic_clock::now();
Examples/Stereo-Inertial/stereo_inertial_realsense_D435i.cc:350:            std::chrono::monotonic_clock::time_point time_Start_Process = std::chrono::monotonic_clock::now();
Examples/Stereo-Inertial/stereo_inertial_realsense_D435i.cc:402:            std::chrono::monotonic_clock::time_point t_Start_Resize = std::chrono::monotonic_clock::now();
Examples/Stereo-Inertial/stereo_inertial_realsense_D435i.cc:414:            std::chrono::monotonic_clock::time_point t_End_Resize = std::chrono::monotonic_clock::now();
Examples/Stereo-Inertial/stereo_inertial_realsense_D435i.cc:425:        std::chrono::monotonic_clock::time_point t_Start_Track = std::chrono::monotonic_clock::now();
Examples/Stereo-Inertial/stereo_inertial_realsense_D435i.cc:434:        std::chrono::monotonic_clock::time_point t_End_Track = std::chrono::monotonic_clock::now();
Examples/Stereo-Inertial/stereo_inertial_euroc.cc:181:            std::chrono::monotonic_clock::time_point t1 = std::chrono::monotonic_clock::now();
Examples/Stereo-Inertial/stereo_inertial_euroc.cc:190:            std::chrono::monotonic_clock::time_point t2 = std::chrono::monotonic_clock::now();
Examples/Stereo-Inertial/stereo_inertial_tum_vi.cc:150:                std::chrono::monotonic_clock::time_point t_Start_Resize = std::chrono::monotonic_clock::now();
Examples/Stereo-Inertial/stereo_inertial_tum_vi.cc:161:                std::chrono::monotonic_clock::time_point t_End_Resize = std::chrono::monotonic_clock::now();
Examples/Stereo-Inertial/stereo_inertial_tum_vi.cc:207:            std::chrono::monotonic_clock::time_point t1 = std::chrono::monotonic_clock::now();
Examples/Stereo-Inertial/stereo_inertial_tum_vi.cc:216:            std::chrono::monotonic_clock::time_point t2 = std::chrono::monotonic_clock::now();
Examples/RGB-D-Inertial/rgbd_inertial_realsense_D435i.cc:351:            std::chrono::monotonic_clock::time_point time_Start_Process = std::chrono::monotonic_clock::now();
Examples/RGB-D-Inertial/rgbd_inertial_realsense_D435i.cc:418:            std::chrono::monotonic_clock::time_point t_Start_Resize = std::chrono::monotonic_clock::now();
Examples/RGB-D-Inertial/rgbd_inertial_realsense_D435i.cc:430:            std::chrono::monotonic_clock::time_point t_End_Resize = std::chrono::monotonic_clock::now();
Examples/RGB-D-Inertial/rgbd_inertial_realsense_D435i.cc:441:        std::chrono::monotonic_clock::time_point t_Start_Track = std::chrono::monotonic_clock::now();
Examples/RGB-D-Inertial/rgbd_inertial_realsense_D435i.cc:451:        std::chrono::monotonic_clock::time_point t_End_Track = std::chrono::monotonic_clock::now();
Examples/Monocular-Inertial/mono_inertial_tum_vi.cc:178:                std::chrono::monotonic_clock::time_point t_Start_Resize = std::chrono::monotonic_clock::now();
Examples/Monocular-Inertial/mono_inertial_tum_vi.cc:188:                std::chrono::monotonic_clock::time_point t_End_Resize = std::chrono::monotonic_clock::now();
Examples/Monocular-Inertial/mono_inertial_tum_vi.cc:201:            std::chrono::monotonic_clock::time_point t1 = std::chrono::monotonic_clock::now();
Examples/Monocular-Inertial/mono_inertial_tum_vi.cc:211:            std::chrono::monotonic_clock::time_point t2 = std::chrono::monotonic_clock::now();
Examples/Monocular-Inertial/mono_inertial_realsense_t265.cc:236:        std::chrono::monotonic_clock::time_point time_Start_Process = std::chrono::monotonic_clock::now();
Examples/Monocular-Inertial/mono_inertial_realsense_t265.cc:263:                std::chrono::monotonic_clock::time_point t_Start_Resize = std::chrono::monotonic_clock::now();
Examples/Monocular-Inertial/mono_inertial_realsense_t265.cc:273:                std::chrono::monotonic_clock::time_point t_End_Resize = std::chrono::monotonic_clock::now();
Examples/Monocular-Inertial/mono_inertial_realsense_t265.cc:314:        std::chrono::monotonic_clock::time_point t_Start_Track = std::chrono::monotonic_clock::now();
Examples/Monocular-Inertial/mono_inertial_realsense_t265.cc:322:        std::chrono::monotonic_clock::time_point t_End_Track = std::chrono::monotonic_clock::now();
Examples/Monocular-Inertial/mono_inertial_euroc.cc:154:                std::chrono::monotonic_clock::time_point t_Start_Resize = std::chrono::monotonic_clock::now();
Examples/Monocular-Inertial/mono_inertial_euroc.cc:164:                std::chrono::monotonic_clock::time_point t_End_Resize = std::chrono::monotonic_clock::now();
Examples/Monocular-Inertial/mono_inertial_euroc.cc:190:            std::chrono::monotonic_clock::time_point t1 = std::chrono::monotonic_clock::now();
Examples/Monocular-Inertial/mono_inertial_euroc.cc:200:            std::chrono::monotonic_clock::time_point t2 = std::chrono::monotonic_clock::now();
Examples/Monocular-Inertial/mono_inertial_realsense_D435i.cc:320:            std::chrono::monotonic_clock::time_point time_Start_Process = std::chrono::monotonic_clock::now();
Examples/Monocular-Inertial/mono_inertial_realsense_D435i.cc:371:            std::chrono::monotonic_clock::time_point t_Start_Resize = std::chrono::monotonic_clock::now();
Examples/Monocular-Inertial/mono_inertial_realsense_D435i.cc:381:            std::chrono::monotonic_clock::time_point t_End_Resize = std::chrono::monotonic_clock::now();
Examples/Monocular-Inertial/mono_inertial_realsense_D435i.cc:392:        std::chrono::monotonic_clock::time_point t_Start_Track = std::chrono::monotonic_clock::now();
Examples/Monocular-Inertial/mono_inertial_realsense_D435i.cc:401:        std::chrono::monotonic_clock::time_point t_End_Track = std::chrono::monotonic_clock::now();
Examples/Stereo/stereo_realsense_t265.cc:132:                std::chrono::monotonic_clock::time_point t_Start_Resize = std::chrono::monotonic_clock::now();
Examples/Stereo/stereo_realsense_t265.cc:143:                std::chrono::monotonic_clock::time_point t_End_Resize = std::chrono::monotonic_clock::now();
Examples/Stereo/stereo_realsense_t265.cc:157:            std::chrono::monotonic_clock::time_point t1 = std::chrono::monotonic_clock::now();
Examples/Stereo/stereo_realsense_t265.cc:168:            std::chrono::monotonic_clock::time_point t2 = std::chrono::monotonic_clock::now();
Examples/Stereo/stereo_kitti.cc:87:            std::chrono::monotonic_clock::time_point t_Start_Resize = std::chrono::monotonic_clock::now();
Examples/Stereo/stereo_kitti.cc:98:            std::chrono::monotonic_clock::time_point t_End_Resize = std::chrono::monotonic_clock::now();
Examples/Stereo/stereo_kitti.cc:108:        std::chrono::monotonic_clock::time_point t1 = std::chrono::monotonic_clock::now();
Examples/Stereo/stereo_kitti.cc:117:        std::chrono::monotonic_clock::time_point t2 = std::chrono::monotonic_clock::now();
Examples/Stereo/stereo_realsense_D435i.cc:265:            std::chrono::monotonic_clock::time_point time_Start_Process = std::chrono::monotonic_clock::now();
Examples/Stereo/stereo_realsense_D435i.cc:285:            std::chrono::monotonic_clock::time_point t_Start_Resize = std::chrono::monotonic_clock::now();
Examples/Stereo/stereo_realsense_D435i.cc:297:            std::chrono::monotonic_clock::time_point t_End_Resize = std::chrono::monotonic_clock::now();
Examples/Stereo/stereo_realsense_D435i.cc:308:        std::chrono::monotonic_clock::time_point t_Start_Track = std::chrono::monotonic_clock::now();
Examples/Stereo/stereo_realsense_D435i.cc:317:        std::chrono::monotonic_clock::time_point t_End_Track = std::chrono::monotonic_clock::now();
Examples/Stereo/stereo_euroc.cc:128:            std::chrono::monotonic_clock::time_point t1 = std::chrono::monotonic_clock::now();
Examples/Stereo/stereo_euroc.cc:137:            std::chrono::monotonic_clock::time_point t2 = std::chrono::monotonic_clock::now();
Examples/Stereo/stereo_tum_vi.cc:123:                std::chrono::monotonic_clock::time_point t_Start_Resize = std::chrono::monotonic_clock::now();
Examples/Stereo/stereo_tum_vi.cc:134:                std::chrono::monotonic_clock::time_point t_End_Resize = std::chrono::monotonic_clock::now();
Examples/Stereo/stereo_tum_vi.cc:157:            std::chrono::monotonic_clock::time_point t1 = std::chrono::monotonic_clock::now();
Examples/Stereo/stereo_tum_vi.cc:166:            std::chrono::monotonic_clock::time_point t2 = std::chrono::monotonic_clock::now();
Examples/RGB-D/rgbd_realsense_D435i.cc:329:            std::chrono::monotonic_clock::time_point time_Start_Process = std::chrono::monotonic_clock::now();
Examples/RGB-D/rgbd_realsense_D435i.cc:365:            std::chrono::monotonic_clock::time_point t_Start_Resize = std::chrono::monotonic_clock::now();
Examples/RGB-D/rgbd_realsense_D435i.cc:377:            std::chrono::monotonic_clock::time_point t_End_Resize = std::chrono::monotonic_clock::now();
Examples/RGB-D/rgbd_realsense_D435i.cc:388:        std::chrono::monotonic_clock::time_point t_Start_Track = std::chrono::monotonic_clock::now();
Examples/RGB-D/rgbd_realsense_D435i.cc:398:        std::chrono::monotonic_clock::time_point t_End_Track = std::chrono::monotonic_clock::now();
Examples/RGB-D/rgbd_tum.cc:100:        std::chrono::monotonic_clock::time_point t1 = std::chrono::monotonic_clock::now();
Examples/RGB-D/rgbd_tum.cc:109:        std::chrono::monotonic_clock::time_point t2 = std::chrono::monotonic_clock::now();
rysch01@rysch01-Legion-Pro-5-2404:~/Projects/teleoperation_spot/cpp/ORB_SLAM3$ 



rysch01@rysch01-Legion-Pro-5-2404:~/Projects/teleoperation_spot/cpp/ORB_SLAM3$ cd ~/Projects/teleoperation_spot/cpp/ORB_SLAM3

# Patch every file under Examples that uses monotonic_clock
sed -i 's/monotonic_clock/steady_clock/g' $(grep -Rl "monotonic_clock" Examples)
rysch01@rysch01-Legion-Pro-5-2404:~/Projects/teleoperation_spot/cpp/ORB_SLAM3$ ^C


cd ~/Projects/teleoperation_spot/cpp/ORB_SLAM3/build

make -j1
cd ~/Projects/teleoperation_spot/cpp/ORB_SLAM3

sed -i 's/monotonic_clock/steady_clock/g' $(grep -Rl "monotonic_clock" .)



export ORB_SLAM3_ROOT_PATH=/home/rysch01/Projects/teleoperation_spot/cpp
export LD_LIBRARY_PATH="$ORB_SLAM3_ROOT_PATH/ORB_SLAM3/lib:$LD_LIBRARY_PATH"


cd ~/Projects/teleoperation_spot/system_ws
source /opt/ros/jazzy/setup.bash

sudo apt install ros-jazzy-cv-bridge ros-jazzy-message-filters -y


cd ~/Projects/teleoperation_spot/system_ws
source /opt/ros/jazzy/setup.bash

sudo apt install ros-jazzy-cv-bridge ros-jazzy-message-filters -y



colcon build --symlink-install --packages-select orbslam3




cd ~/Projects/teleoperation_spot/system_ws/src/orbslam3_ros2
sed -i 's|set(ORB_SLAM3_ROOT_DIR.*|set(ORB_SLAM3_ROOT_DIR "/home/rysch01/Projects/teleoperation_spot/cpp/ORB_SLAM3")|' CMakeModules/FindORB_SLAM3.cmake
export LD_LIBRARY_PATH="/home/rysch01/Projects/teleoperation_spot/cpp/ORB_SLAM3/lib:$LD_LIBRARY_PATH"
sudo apt update
sudo apt install ros-jazzy-cv-bridge ros-jazzy-message-filters -y
sudo apt update
sudo apt install ros-jazzy-cv-bridge ros-jazzy-message-filters -y
cd ~/Projects/teleoperation_spot/system_ws/src/orbslam3_ros2

# Replace old header name with the Jazzy one
grep -Rl "cv_bridge/cv_bridge.h" . | xargs sed -i 's|cv_bridge/cv_bridge.h|cv_bridge/cv_bridge.hpp|g'
sed -i '/set(ENV{PYTHONPATH}/d' CMakeLists.txt
sed -i 's/ament_target_dependencies(stereo-inertial/ament_target_dependencies(stereo-inertial rclcpp sensor_msgs cv_bridge message_filters/' CMakeLists.txt
sed -i '1i set(ORB_SLAM3_ROOT_DIR "~/Projects/teleoperation_spot/cpp/ORB_SLAM3")' CMakeLists.txt
sed -i 's/argv\[4\] = "false"/argv[4] = (char*)"false"/' \
  ~/Projects/teleoperation_spot/system_ws/src/orbslam3_ros2/src/stereo-inertial/stereo-inertial.cpp


  sed -i 's/ament_target_dependencies(mono /ament_target_dependencies(mono rclcpp sensor_msgs cv_bridge message_filters /' \
  ~/Projects/teleoperation_spot/system_ws/src/orbslam3_ros2/CMakeLists.txt

sed -i 's/ament_target_dependencies(rgbd /ament_target_dependencies(rgbd rclcpp sensor_msgs cv_bridge message_filters Pangolin ORB_SLAM3 /' \
  ~/Projects/teleoperation_spot/system_ws/src/orbslam3_ros2/CMakeLists.txt

sed -i 's/ament_target_dependencies(stereo-inertial /ament_target_dependencies(stereo-inertial rclcpp sensor_msgs cv_bridge message_filters /' \
  ~/Projects/teleoperation_spot/system_ws/src/orbslam3_ros2/CMakeLists.txt


find ~/Projects/teleoperation_spot/system_ws/src/orbslam3_ros2/src -name "*-slam-node.hpp" \
  -exec sed -i '1i #include <opencv2/core/core.hpp>' {} \;


cd ~/Projects/teleoperation_spot/system_ws
source /opt/ros/jazzy/setup.bash
colcon build --symlink-install --packages-select orbslam3


sed -i '/include_directories(/a \  ${cv_bridge_INCLUDE_DIRS}\n  ${OpenCV_INCLUDE_DIRS}' \
  ~/Projects/teleoperation_spot/system_ws/src/orbslam3_ros2/CMakeLists.txt

sed -i '/find_package(sensor_msgs REQUIRED)/a find_package(OpenCV REQUIRED)' \
  ~/Projects/teleoperation_spot/system_ws/src/orbslam3_ros2/CMakeLists.txt


cd ~/Projects/teleoperation_spot/system_ws
colcon build --symlink-install --packages-select orbslam3
sed -i '/include_directories(/c\include_directories(\n  include\n  ${ORB_SLAM3_ROOT_DIR}/include\n  ${ORB_SLAM3_ROOT_DIR}/include/CameraModels\n  ${cv_bridge_INCLUDE_DIRS}\n  ${OpenCV_INCLUDE_DIRS}\n  ${Pangolin_INCLUDE_DIRS}\n)' \
  ~/Projects/teleoperation_spot/system_ws/src/orbslam3_ros2/CMakeLists.txt
sed -i '/find_package(sensor_msgs REQUIRED)/a find_package(OpenCV REQUIRED)' \
  ~/Projects/teleoperation_spot/system_ws/src/orbslam3_ros2/CMakeLists.txt
cd ~/Projects/teleoperation_spot/system_ws
colcon build --symlink-install --packages-select orbslam3

sed -i 's|include_directories(|include_directories(\n  include\n  ${ORB_SLAM3_ROOT_DIR}/include\n  ${ORB_SLAM3_ROOT_DIR}/include/CameraModels\n  ${OpenCV_INCLUDE_DIRS}\n  ${cv_bridge_INCLUDE_DIRS}\n  ${Pangolin_INCLUDE_DIRS}\n)|' \
  ~/Projects/teleoperation_spot/system_ws/src/orbslam3_ros2/CMakeLists.txt



cat > ~/Projects/teleoperation_spot/system_ws/src/orbslam3_ros2/CMakeLists.txt << 'EOF'
cmake_minimum_required(VERSION 3.5)
project(orbslam3)

set(CMAKE_MODULE_PATH ${CMAKE_MODULE_PATH} ${CMAKE_CURRENT_SOURCE_DIR}/CMakeModules)

# Default to C++14
if(NOT CMAKE_CXX_STANDARD)
  set(CMAKE_CXX_STANDARD 14)
endif()

if(CMAKE_COMPILER_IS_GNUCXX OR CMAKE_CXX_COMPILER_ID MATCHES "Clang")
  add_compile_options(-Wall -Wextra -Wpedantic)
endif()

find_package(ament_cmake REQUIRED)
find_package(rclcpp REQUIRED)
find_package(sensor_msgs REQUIRED)
find_package(OpenCV REQUIRED)
find_package(cv_bridge REQUIRED)
find_package(message_filters REQUIRED)
find_package(Sophus REQUIRED)
find_package(Pangolin REQUIRED)
find_package(ORB_SLAM3 REQUIRED)

include_directories(
  include
  ${ORB_SLAM3_ROOT_DIR}/include
  ${ORB_SLAM3_ROOT_DIR}/include/CameraModels
  ${OpenCV_INCLUDE_DIRS}
  ${cv_bridge_INCLUDE_DIRS}
  ${Pangolin_INCLUDE_DIRS}
)

link_directories(${ORB_SLAM3_ROOT_DIR}/lib)

add_executable(mono
  src/monocular/mono.cpp
  src/monocular/monocular-slam-node.cpp
)
ament_target_dependencies(mono rclcpp sensor_msgs cv_bridge message_filters ORB_SLAM3 Pangolin)

add_executable(rgbd
  src/rgbd/rgbd.cpp
  src/rgbd/rgbd-slam-node.cpp
)
ament_target_dependencies(rgbd rclcpp sensor_msgs cv_bridge message_filters ORB_SLAM3 Pangolin)

add_executable(stereo
  src/stereo/stereo.cpp
  src/stereo/stereo-slam-node.cpp
)
ament_target_dependencies(stereo rclcpp sensor_msgs cv_bridge message_filters ORB_SLAM3 Pangolin)

add_executable(stereo-inertial
  src/stereo-inertial/stereo-inertial.cpp
  src/stereo-inertial/stereo-inertial-node.cpp
)
ament_target_dependencies(stereo-inertial rclcpp sensor_msgs cv_bridge message_filters ORB_SLAM3 Pangolin)

install(TARGETS mono rgbd stereo stereo-inertial
  DESTINATION lib/${PROJECT_NAME})

ament_package()
EOF



cd ~/Projects/teleoperation_spot/system_ws
colcon build --symlink-install --packages-select orbslam3 --event-handlers console_direct+


/home/rysch01/Projects/teleoperation_spot/cpp/ORB_SLAM3/include/CameraModels/KannalaBrandt8.h:59:9: warning:   when initialized here [-Wreorder]
   59 |         KannalaBrandt8(KannalaBrandt8* pKannala) : GeometricCamera(pKannala->mvParameters), precision(pKannala->precision), mvLappingArea(2,0) ,tvr(nullptr) {
      |         ^~~~~~~~~~~~~~
gmake[2]: *** [CMakeFiles/stereo.dir/build.make:76: CMakeFiles/stereo.dir/src/stereo/stereo.cpp.o] Error 1
gmake[2]: *** Waiting for unfinished jobs....
gmake[2]: *** [CMakeFiles/mono.dir/build.make:76: CMakeFiles/mono.dir/src/monocular/mono.cpp.o] Error 1
gmake[2]: *** Waiting for unfinished jobs....
gmake[2]: *** [CMakeFiles/stereo-inertial.dir/build.make:76: CMakeFiles/stereo-inertial.dir/src/stereo-inertial/stereo-inertial.cpp.o] Error 1
gmake[2]: *** Waiting for unfinished jobs....
gmake[2]: *** [CMakeFiles/rgbd.dir/build.make:76: CMakeFiles/rgbd.dir/src/rgbd/rgbd.cpp.o] Error 1
gmake[2]: *** Waiting for unfinished jobs....
gmake[2]: *** [CMakeFiles/mono.dir/build.make:90: CMakeFiles/mono.dir/src/monocular/monocular-slam-node.cpp.o] Error 1
gmake[1]: *** [CMakeFiles/Makefile2:143: CMakeFiles/mono.dir/all] Error 2
gmake[1]: *** Waiting for unfinished jobs....
gmake[2]: *** [CMakeFiles/stereo.dir/build.make:90: CMakeFiles/stereo.dir/src/stereo/stereo-slam-node.cpp.o] Error 1
gmake[1]: *** [CMakeFiles/Makefile2:195: CMakeFiles/stereo.dir/all] Error 2
gmake[2]: *** [CMakeFiles/rgbd.dir/build.make:90: CMakeFiles/rgbd.dir/src/rgbd/rgbd-slam-node.cpp.o] Error 1
gmake[1]: *** [CMakeFiles/Makefile2:169: CMakeFiles/rgbd.dir/all] Error 2
gmake[2]: *** [CMakeFiles/stereo-inertial.dir/build.make:90: CMakeFiles/stereo-inertial.dir/src/stereo-inertial/stereo-inertial-node.cpp.o] Error 1
gmake[1]: *** [CMakeFiles/Makefile2:221: CMakeFiles/stereo-inertial.dir/all] Error 2
gmake: *** [Makefile:146: all] Error 2
---
Failed   <<< orbslam3 [9.25s, exited with code 2]

Summary: 0 packages finished [9.33s]
  1 package failed: orbslam3
  1 package had stderr output: orbslam3
rysch01@rysch01-Legion-Pro-5-2404:~/Projects/teleoperation_spot/system_ws$ grep -R "fatal" -n ~/Projects/teleoperation_spot/system_ws/build/orbslam3 | head -n 20
rysch01@rysch01-Legion-Pro-5-2404:~/Projects/teleoperation_spot/system_ws$ grep -R "No such file or directory" -n ~/Projects/teleoperation_spot/system_ws/build/orbslam3 | head -n 20
rysch01@rysch01-Legion-Pro-5-2404:~/Projects/teleoperation_spot/system_ws$ grep -R "undefined reference" -n ~/Projects/teleoperation_spot/system_ws/build/orbslam3 | head -n 20
rysch01@rysch01-Legion-Pro-5-2404:~/Projects/teleoperation_spot/system_ws$ grep -R "error:" -n ~/Projects/teleoperation_spot/system_ws/build/orbslam3 | head -n 20
/home/rysch01/Projects/teleoperation_spot/system_ws/build/orbslam3/CMakeFiles/mono.dir/compiler_depend.make:4697:/usr/include/c++/13/system_error:
/home/rysch01/Projects/teleoperation_spot/system_ws/build/orbslam3/CMakeFiles/rgbd.dir/compiler_depend.make:4727:/usr/include/c++/13/system_error:
/home/rysch01/Projects/teleoperation_spot/system_ws/build/orbslam3/CMakeFiles/stereo.dir/compiler_depend.make:4727:/usr/include/c++/13/system_error:
/home/rysch01/Projects/teleoperation_spot/system_ws/build/orbslam3/CMakeFiles/stereo-inertial.dir/compiler_depend.make:4707:/usr/include/c++/13/system_error:
rysch01@rysch01-Legion-Pro-5-2404:~/Projects/teleoperation_spot/system_ws$ cat > ~/Projects/teleoperation_spot/system_ws/src/orbslam3_ros2/CMakeLists.txt << 'EOF'                                     d ~/Projects/teleoperation_spot/system_ws
                                                                            at > ~/Projects/teleoperation_spot/system_ws/src/orbslam3_ros2/CMakeLists.txt << 'EOF'                                        ~/Projects/teleoperation_spot/system_ws/src/rysch01@rysch01-Legion-Pro-5-2404:~/Projects/teleoperation_spot/system_ws$ cat ~/Projects/teleoperation_spot/system_ws/src/orbslam3_ros2/CMakeLists.txt 
cmake_minimum_required(VERSION 3.5)
project(orbslam3)

set(CMAKE_MODULE_PATH ${CMAKE_MODULE_PATH} ${CMAKE_CURRENT_SOURCE_DIR}/CMakeModules)

# Default to C++14
if(NOT CMAKE_CXX_STANDARD)
  set(CMAKE_CXX_STANDARD 14)
endif()

if(CMAKE_COMPILER_IS_GNUCXX OR CMAKE_CXX_COMPILER_ID MATCHES "Clang")
  add_compile_options(-Wall -Wextra -Wpedantic)
endif()

find_package(ament_cmake REQUIRED)
find_package(rclcpp REQUIRED)
find_package(sensor_msgs REQUIRED)
find_package(OpenCV REQUIRED)
find_package(cv_bridge REQUIRED)
find_package(message_filters REQUIRED)
find_package(Sophus REQUIRED)
find_package(Pangolin REQUIRED)
find_package(ORB_SLAM3 REQUIRED)

include_directories(
  include
  ${ORB_SLAM3_ROOT_DIR}/include
  ${ORB_SLAM3_ROOT_DIR}/include/CameraModels
  ${OpenCV_INCLUDE_DIRS}
  ${cv_bridge_INCLUDE_DIRS}
  ${Pangolin_INCLUDE_DIRS}
)

link_directories(${ORB_SLAM3_ROOT_DIR}/lib)

add_executable(mono
  src/monocular/mono.cpp
  src/monocular/monocular-slam-node.cpp
)
ament_target_dependencies(mono rclcpp sensor_msgs cv_bridge message_filters ORB_SLAM3 Pangolin)

add_executable(rgbd
  src/rgbd/rgbd.cpp
  src/rgbd/rgbd-slam-node.cpp
)
ament_target_dependencies(rgbd rclcpp sensor_msgs cv_bridge message_filters ORB_SLAM3 Pangolin)

add_executable(stereo
  src/stereo/stereo.cpp
  src/stereo/stereo-slam-node.cpp
)
ament_target_dependencies(stereo rclcpp sensor_msgs cv_bridge message_filters ORB_SLAM3 Pangolin)

add_executable(stereo-inertial
  src/stereo-inertial/stereo-inertial.cpp
  src/stereo-inertial/stereo-inertial-node.cpp
)
ament_target_dependencies(stereo-inertial rclcpp sensor_msgs cv_bridge message_filters ORB_SLAM3 Pangolin)

install(TARGETS mono rgbd stereo stereo-inertial
  DESTINATION lib/${PROJECT_NAME})

ament_package()
rysch01@rysch01-Legion-Pro-5-2404:~/Projects/teleoperation_spot/system_ws$ 

cd ~/Projects/teleoperation_spot/system_ws

# Nuke only orbslam3 build artifacts
rm -rf build/orbslam3 install/orbslam3 log/latest/orbslam3*
cd ~/Projects/teleoperation_spot/system_ws

colcon build \
  --symlink-install \
  --packages-select orbslam3 \
  --parallel-workers 1 \
  --event-handlers console_direct+ \
  > /tmp/orbslam3_build.log 2>&1


sed -i '/find_package(Sophus REQUIRED)/d' \
  ~/Projects/teleoperation_spot/system_ws/src/orbslam3_ros2/CMakeLists.txt

sed -i 's|${ORB_SLAM3_ROOT_DIR}/include/CameraModels|${ORB_SLAM3_ROOT_DIR}/include/CameraModels\n  ${ORB_SLAM3_ROOT_DIR}/Thirdparty/Sophus|' \
  ~/Projects/teleoperation_spot/system_ws/src/orbslam3_ros2/CMakeLists.txt


sed -i '1iset(ORB_SLAM3_ROOT_DIR "/home/rysch01/Projects/teleoperation_spot/cpp/ORB_SLAM3")\n' \
  ~/Projects/teleoperation_spot/system_ws/src/orbslam3_ros2/CMakeLists.txt
cd ~/Projects/teleoperation_spot/system_ws
rm -rf build/orbslam3 install/orbslam3 log/latest/orbslam3*
'


cd ~/Projects/teleoperation_spot/system_ws

colcon build \
  --symlink-install \
  --packages-select orbslam3 \
  --parallel-workers 1 \
  --event-handlers console_direct+


sed -i '$atarget_link_libraries(mono ${OpenCV_LIBRARIES})\n\
target_link_libraries(rgbd ${OpenCV_LIBRARIES})\n\
target_link_libraries(stereo ${OpenCV_LIBRARIES})\n\
target_link_libraries(stereo-inertial ${OpenCV_LIBRARIES})' \
  ~/Projects/teleoperation_spot/system_ws/src/orbslam3_ros2/CMakeLists.txt


cd ~/Projects/teleoperation_spot/system_ws

ls install/orbslam3/lib/orbslam3
cd ~/Projects/teleoperation_spot/system_ws

ls install/orbslam3/lib/orbslam3

source /opt/ros/jazzy/setup.bash
source ~/Projects/teleoperation_spot/system_ws/install/setup.bash


cd ~/Projects/teleoperation_spot/system_ws

source /opt/ros/jazzy/setup.bash
source install/setup.bash

ros2 run orbslam3 rgbd \
  /home/rysch01/Projects/teleoperation_spot/cpp/ORB_SLAM3/Vocabulary/ORBvoc.txt \
  /home/rysch01/Projects/teleoperation_spot/system_ws/src/orbslam3_ros2/config/xtion_rgbd.yaml \
  --ros-args \
  -r /camera/color/image_raw:=/xtion1/rgb/image_raw \
  -r /camera/aligned_depth_to_color/image_raw:=/xtion1/depth/image_raw \
  -r /camera/color/camera_info:=/xtion1/rgb/camera_info



ls -l \
  /home/rysch01/Projects/teleoperation_spot/system_ws/src/orbslam3_ros2/config




#  cd ~/Projects/teleoperation_spot/system_ws  source /opt/ros/jazzy/setup.bash source install/setup.bash  STAMP=$(date +%Y%m%d_%H%M%S)  ros2 bag record -o "xtion_${STAMP}.bag" \   --regex \   '/.*/rgb/image_raw|/.*/rgb/camera_info|/.*/depth_raw/image|/.*/depth_raw/camera_info|/.*/depth/image|/.*/depth/camera_info|/tf|/tf_static'   ros2 bag play xtion_<timestamp>.bag


cd ~/Projects/teleoperation_spot/cpp/ORB_SLAM3/Vocabulary

# (Optional) see what’s there
ls -lh

# Make sure any bad ORBvoc.txt is gone
rm -f ORBvoc.txt

# Download the official text vocabulary tarball
wget https://github.com/raulmur/ORB_SLAM2/raw/master/Vocabulary/ORBvoc.txt.tar.gz

# Extract it
tar -xvzf ORBvoc.txt.tar.gz

# Confirm size – should be ~1.4G
ls -lh ORBvoc.txt


rm -f ORBvoc.txt

# Download the official text vocabulary tarball
wget https://github.com/raulmur/ORB_SLAM2/raw/master/Vocabulary/ORBvoc.txt.tar.gz

# Extract it
tar -xvzf ORBvoc.txt.tar.gz

# Confirm size – should be ~1.4G
ls -lh ORBvoc.txt
^C
rysch01@rysch01-Legion-Pro-5-2404:~/Projects/teleoperation_spot/system_ws$ cd ~/Projects/teleoperation_spot/cpp/ORB_SLAM3/Vocabulary

# (Optional) see what’s there
ls -lh

# Make sure any bad ORBvoc.txt is gone
rm -f ORBvoc.txt

# Download the official text vocabulary tarball
wget https://github.com/raulmur/ORB_SLAM2/raw/master/Vocabulary/ORBvoc.txt.tar.gz

# Extract it
tar -xvzf ORBvoc.txt.tar.gz

# Confirm size – should be ~1.4G
ls -lh ORBvoc.txt
total 41M
-rw-rw-r-- 1 rysch01 rysch01 41M Dec  3 16:25 ORBvoc.txt.tar.gz
--2025-12-04 15:35:15--  https://github.com/raulmur/ORB_SLAM2/raw/master/Vocabulary/ORBvoc.txt.tar.gz
Resolving github.com (github.com)... 140.82.113.4
Connecting to github.com (github.com)|140.82.113.4|:443... connected.
HTTP request sent, awaiting response... 302 Found
Location: https://raw.githubusercontent.com/raulmur/ORB_SLAM2/master/Vocabulary/ORBvoc.txt.tar.gz [following]
--2025-12-04 15:35:15--  https://raw.githubusercontent.com/raulmur/ORB_SLAM2/master/Vocabulary/ORBvoc.txt.tar.gz
Resolving raw.githubusercontent.com (raw.githubusercontent.com)... 185.199.111.133, 185.199.108.133, 185.199.109.133, ...
Connecting to raw.githubusercontent.com (raw.githubusercontent.com)|185.199.111.133|:443... connected.
HTTP request sent, awaiting response... 200 OK
Length: 42527984 (41M) [application/octet-stream]
Saving to: ‘ORBvoc.txt.tar.gz.1’

ORBvoc.txt.tar.gz.1            100%[===================================================>]  40.56M  9.08MB/s    in 4.7s    

2025-12-04 15:35:20 (8.70 MB/s) - ‘ORBvoc.txt.tar.gz.1’ saved [42527984/42527984]

ORBvoc.txt
-rw-rw-r-- 1 rysch01 rysch01 139M Aug 25  2015 ORBvoc.txt
rysch01@rysch01-Legion-Pro-5-2404:~/Projects/teleoperation_spot/cpp/ORB_SLAM3/Vocabulary$ cd ~/Projects/teleoperation_spot/system_ws

source /opt/ros/jazzy/setup.bash
source install/setup.bash

ros2 run orbslam3 rgbd \
  /home/rysch01/Projects/teleoperation_spot/cpp/ORB_SLAM3/Vocabulary/ORBvoc.txt \
  /home/rysch01/Projects/teleoperation_spot/system_ws/src/orbslam3_ros2/config/xtion_rgbd.yaml \
  --ros-args \
  -r /camera/color/image_raw:=/xtion1/rgb/image_raw \
  -r /camera/aligned_depth_to_color/image_raw:=/xtion1/depth/image_raw \
  -r /camera/color/camera_info:=/xtion1/rgb/camera_info

ORB-SLAM3 Copyright (C) 2017-2020 Carlos Campos, Richard Elvira, Juan J. Gómez, José M.M. Montiel and Juan D. Tardós, University of Zaragoza.
ORB-SLAM2 Copyright (C) 2014-2016 Raúl Mur-Artal, José M.M. Montiel and Juan D. Tardós, University of Zaragoza.
This program comes with ABSOLUTELY NO WARRANTY;
This is free software, and you are welcome to redistribute it
under certain conditions. See LICENSE.txt.

Input sensor was set to: RGB-D
Loading settings from /home/rysch01/Projects/teleoperation_spot/system_ws/src/orbslam3_ros2/config/xtion_rgbd.yaml
	-Loaded camera 1
Camera.newHeight optional parameter does not exist...
Camera.newWidth optional parameter does not exist...
	-Loaded image info
	-Loaded RGB-D calibration
	-Loaded ORB settings
Viewer.imageViewScale optional parameter does not exist...
	-Loaded viewer settings
System.LoadAtlasFromFile optional parameter does not exist...
System.SaveAtlasToFile optional parameter does not exist...
	-Loaded Atlas settings
System.thFarPoints optional parameter does not exist...
	-Loaded misc parameters
----------------------------------
SLAM settings: 
	-Camera 1 parameters (Pinhole): [ 517.306 516.469 318.643 255.314 ]
	-Camera 1 distortion parameters: [  0.262383 -0.953104 -0.005358 0.002628 1.16331 ]
	-Original image size: [ 640 , 480 ]
	-Current image size: [ 640 , 480 ]
	-Sequence FPS: 30
	-RGB-D depth map factor: 5000
	-Features per image: 1000
	-ORB scale factor: 1.2
	-ORB number of scales: 8
	-Initial FAST threshold: 20
	-Min FAST threshold: 7


Loading ORB Vocabulary. This could take a while...
Vocabulary loaded!

Initialization of Atlas from scratch 
Creation of new map with id: 0
Creation of new map with last KF id: 0
Seq. Name: 
There are 1 cameras in the atlas
Camera 0 is pinhole
Shutdown

Saving keyframe trajectory to KeyFrameTrajectory.txt ...
double free or corruption (out)
[ros2run]: Aborted
rysch01@rysch01-Legion-Pro-5-2404:~/Projects/teleoperation_spot/system_ws$ 




rm -f ORBvoc.txt

# Download the official text vocabulary tarball
wget https://github.com/raulmur/ORB_SLAM2/raw/master/Vocabulary/ORBvoc.txt.tar.gz

# Extract it
tar -xvzf ORBvoc.txt.tar.gz

# Confirm size – should be ~1.4G
ls -lh ORBvoc.txt
^C
rysch01@rysch01-Legion-Pro-5-2404:~/Projects/teleoperation_spot/system_ws$ cd ~/Projects/teleoperation_spot/cpp/ORB_SLAM3/Vocabulary

# (Optional) see what’s there
ls -lh

# Make sure any bad ORBvoc.txt is gone
rm -f ORBvoc.txt

# Download the official text vocabulary tarball
wget https://github.com/raulmur/ORB_SLAM2/raw/master/Vocabulary/ORBvoc.txt.tar.gz

# Extract it
tar -xvzf ORBvoc.txt.tar.gz

# Confirm size – should be ~1.4G
ls -lh ORBvoc.txt
total 41M
-rw-rw-r-- 1 rysch01 rysch01 41M Dec  3 16:25 ORBvoc.txt.tar.gz
--2025-12-04 15:35:15--  https://github.com/raulmur/ORB_SLAM2/raw/master/Vocabulary/ORBvoc.txt.tar.gz
Resolving github.com (github.com)... 140.82.113.4
Connecting to github.com (github.com)|140.82.113.4|:443... connected.
HTTP request sent, awaiting response... 302 Found
Location: https://raw.githubusercontent.com/raulmur/ORB_SLAM2/master/Vocabulary/ORBvoc.txt.tar.gz [following]
--2025-12-04 15:35:15--  https://raw.githubusercontent.com/raulmur/ORB_SLAM2/master/Vocabulary/ORBvoc.txt.tar.gz
Resolving raw.githubusercontent.com (raw.githubusercontent.com)... 185.199.111.133, 185.199.108.133, 185.199.109.133, ...
Connecting to raw.githubusercontent.com (raw.githubusercontent.com)|185.199.111.133|:443... connected.
HTTP request sent, awaiting response... 200 OK
Length: 42527984 (41M) [application/octet-stream]
Saving to: ‘ORBvoc.txt.tar.gz.1’

ORBvoc.txt.tar.gz.1            100%[===================================================>]  40.56M  9.08MB/s    in 4.7s    

2025-12-04 15:35:20 (8.70 MB/s) - ‘ORBvoc.txt.tar.gz.1’ saved [42527984/42527984]

ORBvoc.txt
-rw-rw-r-- 1 rysch01 rysch01 139M Aug 25  2015 ORBvoc.txt
rysch01@rysch01-Legion-Pro-5-2404:~/Projects/teleoperation_spot/cpp/ORB_SLAM3/Vocabulary$ cd ~/Projects/teleoperation_spot/system_ws

source /opt/ros/jazzy/setup.bash
source install/setup.bash

ros2 run orbslam3 rgbd \
  /home/rysch01/Projects/teleoperation_spot/cpp/ORB_SLAM3/Vocabulary/ORBvoc.txt \
  /home/rysch01/Projects/teleoperation_spot/system_ws/src/orbslam3_ros2/config/xtion_rgbd.yaml \
  --ros-args \
  -r /camera/color/image_raw:=/xtion1/rgb/image_raw \
  -r /camera/aligned_depth_to_color/image_raw:=/xtion1/depth/image_raw \
  -r /camera/color/camera_info:=/xtion1/rgb/camera_info

ORB-SLAM3 Copyright (C) 2017-2020 Carlos Campos, Richard Elvira, Juan J. Gómez, José M.M. Montiel and Juan D. Tardós, University of Zaragoza.
ORB-SLAM2 Copyright (C) 2014-2016 Raúl Mur-Artal, José M.M. Montiel and Juan D. Tardós, University of Zaragoza.
This program comes with ABSOLUTELY NO WARRANTY;
This is free software, and you are welcome to redistribute it
under certain conditions. See LICENSE.txt.

Input sensor was set to: RGB-D
Loading settings from /home/rysch01/Projects/teleoperation_spot/system_ws/src/orbslam3_ros2/config/xtion_rgbd.yaml
	-Loaded camera 1
Camera.newHeight optional parameter does not exist...
Camera.newWidth optional parameter does not exist...
	-Loaded image info
	-Loaded RGB-D calibration
	-Loaded ORB settings
Viewer.imageViewScale optional parameter does not exist...
	-Loaded viewer settings
System.LoadAtlasFromFile optional parameter does not exist...
System.SaveAtlasToFile optional parameter does not exist...
	-Loaded Atlas settings
System.thFarPoints optional parameter does not exist...
	-Loaded misc parameters
----------------------------------
SLAM settings: 
	-Camera 1 parameters (Pinhole): [ 517.306 516.469 318.643 255.314 ]
	-Camera 1 distortion parameters: [  0.262383 -0.953104 -0.005358 0.002628 1.16331 ]
	-Original image size: [ 640 , 480 ]
	-Current image size: [ 640 , 480 ]
	-Sequence FPS: 30
	-RGB-D depth map factor: 5000
	-Features per image: 1000
	-ORB scale factor: 1.2
	-ORB number of scales: 8
	-Initial FAST threshold: 20
	-Min FAST threshold: 7


Loading ORB Vocabulary. This could take a while...
Vocabulary loaded!

Initialization of Atlas from scratch 
Creation of new map with id: 0
Creation of new map with last KF id: 0
Seq. Name: 
There are 1 cameras in the atlas
Camera 0 is pinhole
Shutdown

Saving keyframe trajectory to KeyFrameTrajectory.txt ...
double free or corruption (out)
[ros2run]: Aborted
rysch01@rysch01-Legion-Pro-5-2404:~/Projects/teleoperation_spot/system_ws$ 



  Resolution Mode Parameters

  Add these parameters to the parameters=[{...}] section in single_asus_xtion.launch.py:

  parameters=[{
      'device_id': device_id,

      # Color/RGB resolution modes:
      'color_mode': '5',   # Options:
                           # '1' = 320x240 @ 30fps
                           # '5' = 640x480 @ 30fps (DEFAULT)
                           # '9' = 1280x1024 @ 30fps (SXGA - max for Xtion)

      # Depth resolution modes:
      'depth_mode': '5',   # Options:
                           # '1' = 320x240 @ 30fps (QVGA)
                           # '5' = 640x480 @ 30fps (VGA - DEFAULT, max for depth)
                           # Note: Depth is limited to 640x480 by hardware

      # IR resolution modes (if using IR instead of RGB):
      'ir_mode': '5',      # Same options as depth_mode
  }],

  Key Points

  - Default: Mode 5 (640x480 @ 30fps) for all streams
  - Max RGB: Mode 9 (1280x1024 @ 30fps)
  - Max Depth: Mode 5 (640x480 @ 30fps) - hardware limitation
  - Lower res options: Mode 1 (320x240) for faster processing/bandwidth

  Example Configurations

  High quality RGB with standard depth:
  'color_mode': '9',   # 1280x1024
  'depth_mode': '5',   # 640x480

  Balanced (current default):
  'color_mode': '5',   # 640x480
  'depth_mode': '5',   # 640x480

  Low bandwidth/fast processing:
  'color_mode': '1',   # 320x240
  'depth_mode': '1',   # 320x240



rysch01@rysch01-Legion-Pro-5-2404:~/Projects/teleoperation_spot/system_ws$ ros2 topic echo /camA/rgb/camera_info --once
header:
  stamp:
    sec: 1764794703
    nanosec: 687476672
  frame_id: openni_rgb_optical_frame
height: 480
width: 640
distortion_model: plumb_bob
d:
- 0.0
- 0.0
- 0.0
- 0.0
- 0.0
k:
- 570.3422241210938
- 0.0
- 319.5
- 0.0
- 570.3422241210938
- 239.5
- 0.0
- 0.0
- 1.0
r:
- 1.0
- 0.0
- 0.0
- 0.0
- 1.0
- 0.0
- 0.0
- 0.0
- 1.0
p:
- 570.3422241210938
- 0.0
- 319.5
- 0.0
- 0.0
- 570.3422241210938
- 239.5
- 0.0
- 0.0
- 0.0
- 1.0
- 0.0
binning_x: 0
binning_y: 0
roi:
  x_offset: 0
  y_offset: 0
  height: 0
  width: 0
  do_rectify: false
---
rysch01@rysch01-Legion-Pro-5-2404:~/Projects/teleoperation_spot/system_ws$ ros2 topic echo /camB/rgb/camera_info --once
header:
  stamp:
    sec: 1764794708
    nanosec: 25182912
  frame_id: openni_rgb_optical_frame
height: 480
width: 640
distortion_model: plumb_bob
d:
- 0.0
- 0.0
- 0.0
- 0.0
- 0.0
k:
- 570.3422241210938
- 0.0
- 319.5
- 0.0
- 570.3422241210938
- 239.5
- 0.0
- 0.0
- 1.0
r:
- 1.0
- 0.0
- 0.0
- 0.0
- 1.0
- 0.0
- 0.0
- 0.0
- 1.0
p:
- 570.3422241210938
- 0.0
- 319.5
- 0.0
- 0.0
- 570.3422241210938
- 239.5
- 0.0
- 0.0
- 0.0
- 1.0
- 0.0
binning_x: 0
binning_y: 0
roi:
  x_offset: 0
  y_offset: 0
  height: 0
  width: 0
  do_rectify: false
---
rysch01@rysch01-Legion-Pro-5-2404:~/Projects/teleoperation_spot/system_ws$ 




cat <<'EOF' > ~/Projects/teleoperation_spot/system_ws/src/orbslam3_ros2/config/xtionA_rgbd.yaml
# RGB-D Configuration for Xtion Camera A

Camera.type: "PinHole"
Camera.fx: 570.3422241210938
Camera.fy: 570.3422241210938
Camera.cx: 319.5
Camera.cy: 239.5

Camera.k1: 0.0
Camera.k2: 0.0
Camera.p1: 0.0
Camera.p2: 0.0
Camera.k3: 0.0

Camera.width: 640
Camera.height: 480
Camera.fps: 30
Camera.RGB: 1

Camera.depth_factor: 1000.0

ORBextractor.nFeatures: 1000
ORBextractor.scaleFactor: 1.2
ORBextractor.nLevels: 8
ORBextractor.iniThFAST: 20
ORBextractor.minThFAST: 7

Viewer.keyFrameSize: 0.03
Viewer.keyFrameLineWidth: 1
Viewer.graphLineWidth: 0.9
Viewer.pointSize: 2
Viewer.cameraSize: 0.08
Viewer.cameraLineWidth: 3
Viewer.viewpointX: 0
Viewer.viewpointY: -0.7
Viewer.viewpointZ: -1.8
Viewer.viewpointF: 500
EOF




cat <<'EOF' > ~/Projects/teleoperation_spot/system_ws/src/orbslam3_ros2/config/xtionB_rgbd.yaml
# RGB-D Configuration for Xtion Camera B

Camera.type: "PinHole"
Camera.fx: 570.3422241210938
Camera.fy: 570.3422241210938
Camera.cx: 319.5
Camera.cy: 239.5

Camera.k1: 0.0
Camera.k2: 0.0
Camera.p1: 0.0
Camera.p2: 0.0
Camera.k3: 0.0

Camera.width: 640
Camera.height: 480
Camera.fps: 30
Camera.RGB: 1

Camera.depth_factor: 1000.0

ORBextractor.nFeatures: 1000
ORBextractor.scaleFactor: 1.2
ORBextractor.nLevels: 8
ORBextractor.iniThFAST: 20
ORBextractor.minThFAST: 7

Viewer.keyFrameSize: 0.03
Viewer.keyFrameLineWidth: 1
Viewer.graphLineWidth: 0.9
Viewer.pointSize: 2
Viewer.cameraSize: 0.08
Viewer.cameraLineWidth: 3
Viewer.viewpointX: 0
Viewer.viewpointY: -0.7
Viewer.viewpointZ: -1.8
Viewer.viewpointF: 500
EOF



cat <<'EOF' > ~/Projects/teleoperation_spot/system_ws/src/orbslam3_ros2/config/multi_xtion_rgbd.yaml
# Multi-Xtion RGB-D Configuration for ORB-SLAM3

NumCameras: 2

# =======================================================
# Camera 0 (Xtion A)
# =======================================================
Camera0.type: "PinHole"
Camera0.fx: 570.3422241210938
Camera0.fy: 570.3422241210938
Camera0.cx: 319.5
Camera0.cy: 239.5

Camera0.k1: 0.0
Camera0.k2: 0.0
Camera0.p1: 0.0
Camera0.p2: 0.0
Camera0.k3: 0.0

Camera0.width: 640
Camera0.height: 480
Camera0.fps: 30
Camera0.RGB: 1
Camera0.depth_factor: 1000.0

# Identity extrinsic until calibrated
Camera1.T_cn_cnm1:
  - [1, 0, 0, 0]
  - [0, 1, 0, 0]
  - [0, 0, 1, 0]
  - [0, 0, 0, 1]

# =======================================================
# Camera 1 (Xtion B)
# =======================================================
Camera1.type: "PinHole"
Camera1.fx: 570.3422241210938
Camera1.fy: 570.3422241210938
Camera1.cx: 319.5
Camera1.cy: 239.5

Camera1.k1: 0.0
Camera1.k2: 0.0
Camera1.p1: 0.0
Camera1.p2: 0.0
Camera1.k3: 0.0

Camera1.width: 640
Camera1.height: 480
Camera1.fps: 30
Camera1.RGB: 1
Camera1.depth_factor: 1000.0

# Shared ORB extractor parameters
ORBextractor.nFeatures: 1200
ORBextractor.scaleFactor: 1.2
ORBextractor.nLevels: 8
ORBextractor.iniThFAST: 20
ORBextractor.minThFAST: 7
EOF



ros2 run orbslam3 rgbd \
  ~/Projects/teleoperation_spot/cpp/ORB_SLAM3/Vocabulary/ORBvoc.txt \
  ~/Projects/teleoperation_spot/system_ws/src/orbslam3_ros2/config/xtionA_rgbd.yaml \
  --ros-args \
  -r /camera/color/image_raw:=/camA/rgb/image_raw \
  -r /camera/aligned_depth_to_color/image_raw:=/camA/depth/image_raw \
  -r /camera/color/camera_info:=/camA/rgb/camera_info



will it give me the trajectories and poses of the cameras in a shared map at each tiemstamp though? cant i just take the pose at a given timestamp (whether recorded and interpolated) to determine the extrinsics
rysch01@rysch01-Legion-Pro-5-2404:~/Projects/teleoperation_spot/system_ws$ cat <<'EOF' > ~/Projects/teleoperation_spot/system_ws/src/orbslam3_ros2/config/xtionA_rgbd.yaml# RGB-D Configuration for Xtion Camera ACamera.type: "PinHole"Camera.fx: 570.3422241210938Camera.fy: 570.3422241210938Camera.cx: 319.5Camera.cy: 239.5Camera.k1: 0.0Camera.k2: 0.0Camera.p1: 0.0Camera.p2: 0.0Camera.k3: 0.0Camera.width: 640Camera.height: 480Camera.fps: 30Camera.RGB: 1Camera.depth_factor: 1000.0ORBextractor.nFeatures: 1000ORBextractor.scaleFactor: 1.2ORBextractor.nLevels: 8ORBextractor.iniThFAST: 20ORBextractor.minThFAST: 7Viewer.keyFrameSize: 0.03Viewer.keyFrameLineWidth: 1EOFwer.viewpointF: 5008 39rysch01@rysch01-Legion-Pro-5-2404:~/Projects/teleoperation_spot/system_ws$ cat <<'EOF' > ~/Projects/teleoperation_spot/system_ws/src/orbslam3_ros2/config/xtionB_rgbd.yaml# RGB-D Configuration for Xtion Camera BCamera.type: "PinHole"Camera.fx: 570.3422241210938Camera.fy: 570.3422241210938Camera.cx: 319.5Camera.cy: 239.5Camera.k1: 0.0Camera.k2: 0.0Camera.p1: 0.0Camera.p2: 0.0Camera.k3: 0.0Camera.width: 640Camera.height: 480Camera.fps: 30Camera.RGB: 1Camera.depth_factor: 1000.0ORBextractor.nFeatures: 1000ORBextractor.scaleFactor: 1.2ORBextractor.nLevels: 8ORBextractor.iniThFAST: 20ORBextractor.minThFAST: 7Viewer.keyFrameSize: 0.03Viewer.keyFrameLineWidth: 1EOFwer.viewpointF: 5008 39rysch01@rysch01-Legion-Pro-5-2404:~/Projects/teleoperation_spot/system_ws$ cat <<'EOF' > ~/Projects/teleoperation_spot/system_ws/src/orbslam3_ros2/config/multi_xtion_rgbd.yaml# Multi-Xtion RGB-D Configuration for ORB-SLAM3NumCameras: 2# =======================================================# Camera 0 (Xtion A)# =======================================================Camera0.type: "PinHole"Camera0.fx: 570.3422241210938Camera0.fy: 570.3422241210938Camera0.cx: 319.5Camera0.cy: 239.5Camera0.k1: 0.0Camera0.k2: 0.0Camera0.p1: 0.0Camera0.p2: 0.0Camera0.k3: 0.0Camera0.width: 640Camera0.height: 480Camera0.fps: 30Camera0.RGB: 1Camera0.depth_factor: 1000.0# Identity extrinsic until calibratedCamera1.T_cn_cnm1:- [1, 0, 0, 0]- [0, 1, 0, 0]EOFextractor.minThFAST: 701.2ters========================rysch01@rysch01-Legion-Pro-5-2404:~/Projects/teleoperation_spot/system_ws$ ros2 run orbslam3 rgbd \~/Projects/teleoperation_spot/cpp/ORB_SLAM3/Vocabulary/ORBvoc.txt \~/Projects/teleoperation_spot/system_ws/src/orbslam3_ros2/config/xtionA_rgbd.yaml \--ros-args \-r /camera/color/image_raw:=/camA/rgb/image_raw \-r /camera/aligned_depth_to_color/image_raw:=/camA/depth/image_raw \-r /camera/color/camera_info:=/camA/rgb/camera_infoPackage 'orbslam3' not foundrysch01@rysch01-Legion-Pro-5-2404:~/Projects/teleoperation_spot/system_ws$
rysch01@rysch01-Legion-Pro-5-2404:~/Projects/teleoperation_spot/system_ws$ 


ros2 run orbslam3 rgbd \
  ~/Projects/teleoperation_spot/cpp/ORB_SLAM3/Vocabulary/ORBvoc.txt \
  ~/Projects/teleoperation_spot/system_ws/src/orbslam3_ros2/config/xtionA_rgbd.yaml \
  --ros-args \
  -r /camera/color/image_raw:=/camA/rgb/image_raw \
  -r /camera/aligned_depth_to_color/image_raw:=/camA/depth/image_raw \
  -r /camera/color/camera_info:=/camA/rgb/camera_info

Package 'orbslam3' not found




dont you need feature matches to get SE(3)? or does the trajectory alignment just find rigid transforms that allow paths to match at every timestep?



You’ve basically got it — just need to tighten the order and clarify what each step is doing.

Let’s lay out a clean pipeline for **two RGB-D cameras A and B** on a rigid rig.

---

## ✅ Big-picture pipeline

1. **Run ORB-SLAM3 RGB-D separately on each camera**

   * Run once on `/camA/...` and once on `/camB/...`, either:

     * **Online** (two nodes while recording), or
     * **Offline** by replaying the bag and remapping topics.
   * Each run gives you a trajectory:

     * ( T^{A}_{W_A \rightarrow C_A}(t) )
     * ( T^{B}_{W_B \rightarrow C_B}(t) )
       where (W_A) and (W_B) are *independent world/map frames*.

2. **Export camera trajectories with timestamps**

   * From each run, get a file like:

     * `traj_camA.txt`: time, pose of camera A
     * `traj_camB.txt`: time, pose of camera B
   * Each line:
     `t  x  y  z  qx  qy  qz  qw`
   * (This can be from ORB-SLAM3’s `KeyFrameTrajectory.txt`, a ROS topic you log, or a small patch to print poses.)

3. **Time-align the two trajectories**

   * Choose one timeline (e.g. camera A) or a common regular grid.
   * For each chosen timestamp ( t_i ):

     * Interpolate pose of A → ( T^A(t_i) )
     * Interpolate pose of B → ( T^B(t_i) )
   * Keep only times where both cameras have valid poses and the rig was actually moving (throw away super-static segments if they’re noisy).

4. **Trajectory alignment (Umeyama / Horn) to merge the worlds**

   * Extract **positions** from the poses:

     * ( p^A_i = \text{translation}(T^A(t_i)) )
     * ( p^B_i = \text{translation}(T^B(t_i)) )
   * Use Umeyama/Horn/Procrustes to find the best rigid transform:
     [
     p^A_i \approx R , p^B_i + t
     ]
   * This gives you:

     * ( T_{W_A \leftarrow W_B} ) — how to map B’s world into A’s world.
   * Apply it to **all** B poses to get them in the same world:
     [
     T^{B}*{W_A \rightarrow C_B}(t_i) = T*{W_A \leftarrow W_B} \cdot T^{B}_{W_B \rightarrow C_B}(t_i)
     ]

   Now both trajectories live in the **same map frame (W_A)**.

5. **Compute relative camera-to-camera transforms at each timestamp**

   * You have:

     * ( T^{A}_{W_A \rightarrow C_A}(t_i) )
     * ( T^{B}_{W_A \rightarrow C_B}(t_i) ) (already mapped to (W_A))
   * For each ( t_i ), compute the instantaneous extrinsic:
     [
     T_{C_A \rightarrow C_B}(t_i)
     = \big(T^{A}*{W_A \rightarrow C_A}(t_i)\big)^{-1}
     \cdot T^{B}*{W_A \rightarrow C_B}(t_i)
     ]
   * Ideally, because the rig is rigid, **all** these (T_{C_A \rightarrow C_B}(t_i)) should be (nearly) the same.

6. **Average / robustly estimate the fixed extrinsic**

   * Split each ( T_{C_A \rightarrow C_B}(t_i) ) into rotation (R_i) and translation (t_i).
   * Do:

     * **Rotation**: average on SO(3) (e.g. via averaging quaternions and re-normalizing, or a small eigenproblem).
     * **Translation**: simple mean or robust mean (e.g. discard big outliers).
   * The result is your **final extrinsic**:
     [
     \hat{T}_{C_A \rightarrow C_B} = (\hat{R}, \hat{t})
     ]

   You can then:

   * Plug this into your ROS TF tree (`camA → camB`)
   * Or bake it into your multi-camera calibration YAMLs.

---

## 🔁 Where your list matches

You said:

> orbslam on each
> then time align
> then umeyama/horn/procrustes alignment to get rigid
> then interpolate at timesteps
> then calcualte average relative pose transforms compared to a reference point

Slight tweak to order / wording:

1. ORB-SLAM3 on each camera ✅
2. Export trajectories ✅
3. **Interpolate to time-align** ✅
4. Use Umeyama/Horn on the **aligned positions** to get **world-to-world rigid transform** ✅
5. Transform camera B’s poses into A’s world ✅
6. Compute (T_{C_A \rightarrow C_B}(t)) for each time and **average** to get a single rigid extrinsic ✅

Conceptually you were right — I just split "interpolate" into two uses:

* once for **time alignment**,
* once implicitly when we compute per-timestep relative transforms.

---

If you want, next I can:

* Write a **concrete Python script skeleton** that:

  * loads two `traj_*.txt` files,
  * time-aligns them,
  * runs Umeyama,
  * outputs `T_camA_camB` as a 4×4 matrix and a YAML block ready for ROS.





Yep, totally – the exact same idea scales to **N cameras** on a rigid rig. You just need to structure it around a **reference frame** and treat all other cameras relative to that.

Let’s call your cameras (C_0, C_1, \dots, C_{N-1}).

---

## 🔧 Assumptions

* All cameras are **rigidly mounted** together (no flex).
* You have a **single dataset** (bag) where all cameras move together.
* Each camera sees *enough* motion / overlap to give a decent trajectory.

---

## 1. Run ORB-SLAM3 separately per camera

For each camera (C_k):

* Make a config like `xtionCk_rgbd.yaml` (with its intrinsics).
* Run:

```bash
ros2 run orbslam3 rgbd \
  /path/to/ORBvoc.txt \
  /path/to/xtionCk_rgbd.yaml \
  --ros-args \
  -r /camera/color/image_raw:=/camK/rgb/image_raw \
  -r /camera/aligned_depth_to_color/image_raw:=/camK/depth/image_raw \
  -r /camera/color/camera_info:=/camK/rgb/camera_info
```

You’ll get a trajectory for each camera:

* (T^{C_k}_{W_k \rightarrow C_k}(t)) (camera in its **own** SLAM world (W_k))

Export/save these to something like:

* `traj_C0.txt`, `traj_C1.txt`, ..., `traj_C{N-1}.txt`

---

## 2. Choose a reference camera

Pick **one camera as the reference**, say (C_0).
Its world is (W_0). Every other trajectory will be mapped into this world.

---

## 3. Time-align every camera with the reference

For each other camera (C_k), (k = 1..N-1):

1. Load `traj_C0.txt` and `traj_Ck.txt`.
2. Build a **common time grid** (e.g. timestamps from C0, or a regular grid).
3. For each timestamp (t_i) where both trajectories are valid:

   * Interpolate pose of C0 → (T^{C_0}(t_i))
   * Interpolate pose of Ck → (T^{C_k}(t_i))
4. Collect matched position pairs:

   * (p^0_i = \text{translation}(T^{C_0}(t_i)))
   * (p^k_i = \text{translation}(T^{C_k}(t_i)))

(You can also filter out low-motion segments if you want better conditioning.)

---

## 4. Align each world to the reference world (Umeyama / Horn per camera)

For camera (C_k):

* Run Umeyama/Horn on ({ (p^k_i \rightarrow p^0_i) }) to estimate:

[
p^0_i \approx R_{0k} , p^k_i + t_{0k}
]

This gives a rigid transform:

[
T_{W_0 \leftarrow W_k} = (R_{0k}, t_{0k})
]

Apply this to **all** poses of camera (C_k):

[
\tilde{T}^{C_k}*{W_0 \rightarrow C_k}(t)
= T*{W_0 \leftarrow W_k} \cdot T^{C_k}_{W_k \rightarrow C_k}(t)
]

Now every camera’s trajectory is in the **same world frame (W_0)**.

Do this for all (k = 1..N-1).

---

## 5. Compute per-timestep camera-to-camera extrinsics

Now you have, in world (W_0):

* (T^{C_0}_{W_0 \rightarrow C_0}(t_i))
* ( \tilde{T}^{C_k}_{W_0 \rightarrow C_k}(t_i)) for each (k).

For each timestamp (t_i) where both C0 and Ck are valid:

[
T_{C_0 \rightarrow C_k}(t_i)
= \big(T^{C_0}*{W_0 \rightarrow C_0}(t_i)\big)^{-1}
\cdot \tilde{T}^{C_k}*{W_0 \rightarrow C_k}(t_i)
]

That’s the **instantaneous extrinsic** between C0 and Ck.

Collect all these (T_{C_0 \rightarrow C_k}(t_i)) over the whole run.

---

## 6. Robustly estimate a single extrinsic per camera

For each camera (C_k):

* Split each (T_{C_0\rightarrow C_k}(t_i)) into rotation (R_i) and translation (t_i).

Then:

* **Rotation**: average quaternions or do a small SO(3) mean.
* **Translation**: simple mean, or robust mean (e.g. discard outliers).

Result:

[
\hat{T}_{C_0 \rightarrow C_k} = (\hat{R}_k, \hat{t}_k)
]

Do this for every (k), and you now have a **rigid multi-camera rig**:

* Frame = (C_0) (or define a synthetic `rig` frame)
* Extrinsics:

  * (T_{C_0 \rightarrow C_1})
  * (T_{C_0 \rightarrow C_2})
  * …
  * (T_{C_0 \rightarrow C_{N-1}})

You can turn these into:

* A TF tree, or
* A multi-camera calibration YAML for any downstream system.

---

## 7. (Optional) Make it “fully multi-way” instead of pairwise

What we described is **reference-based** (everything relative to C0). For most rigs, that’s totally fine.

If you want to be fancier / more “global”:

* Build a **graph** of all cameras and overlapping time segments.
* Solve a joint least-squares problem for all transforms (T_{C_i \rightarrow C_j}) at once (like multi-trajectory alignment).

But that’s extra sophistication; you don’t need it to get a **good, practical N-camera calibration**.

---

If you’d like, next I can sketch a **Python script outline** that:

* Handles an arbitrary list of `traj_C*.txt` files,
* Picks C0 as reference,
* Runs Umeyama per camera,
* Outputs a little block of YAML per camera like:

```yaml
cam1:
  T_C0_C1:
    translation: [tx, ty, tz]
    rotation_quat: [qx, qy, qz, qw]
```




cd ~/Projects/teleoperation_spot/system_ws

# Base ROS
source /opt/ros/jazzy/setup.bash

# Your workspace overlay
source install/setup.bash

# Sanity check: does ROS2 see the package?
ros2 pkg list | grep orbslam3


cd ~/Projects/teleoperation_spot/system_ws
colcon build --packages-select orbslam3

source /opt/ros/jazzy/setup.bash
source install/setup.bash
ros2 pkg list | grep orbslam3



cd ~/Projects/teleoperation_spot/system_ws

# Backup your current file just in case
cp src/orbslam3_ros2/config/xtionA_rgbd.yaml \
   src/orbslam3_ros2/config/xtionA_rgbd.yaml.bak

# Overwrite xtionA_rgbd.yaml with the official TUM1.yaml
cp ~/Projects/teleoperation_spot/cpp/ORB_SLAM3/Examples/RGB-D/TUM1.yaml \
   src/orbslam3_ros2/config/xtionA_rgbd.yaml



rysch01@rysch01-Legion-Pro-5-2404:~/Projects/teleoperation_spot/system_ws$ ros topic list
Command 'ros' not found, but there are 13 similar ones.
rysch01@rysch01-Legion-Pro-5-2404:~/Projects/teleoperation_spot/system_ws$ ros2 topic list
/camA/depth/camera_info
/camA/depth/image
/camA/depth_raw/camera_info
/camA/depth_raw/image
/camA/rgb/camera_info
/camA/rgb/image_raw
/camB/depth/camera_info
/camB/depth/image
/camB/depth_raw/camera_info
/camB/depth_raw/image
/camB/rgb/camera_info
/camB/rgb/image_raw
/events/read_split
/parameter_events
/rosout
rysch01@rysch01-Legion-Pro-5-2404:~/Projects/teleoperation_spot/system_ws$ 

h01@rysch01-Legion-Pro-5-2404:~/Projects/teleoperation_spot/system_ws$ ros2 bag play xtion_20251203_154457.bag/ --loop
[INFO] [1764884310.667911094] [rosbag2_player]: Set rate to 1
[INFO] [1764884310.672398904] [rosbag2_player]: Adding keyboard callbacks.
[INFO] [1764884310.672413171] [rosbag2_player]: Press SPACE for Pause/Resume
[INFO] [1764884310.672416241] [rosbag2_player]: Press CURSOR_RIGHT for Play Next Message
[INFO] [1764884310.672418972] [rosbag2_player]: Press CURSOR_UP for Increase Rate 10%
[INFO] [1764884310.672421343] [rosbag2_player]: Press CURSOR_DOWN for Decrease Rate 10%
[INFO] [1764884310.673610582] [rosbag2_player]: Playback until timestamp: -1

rysch01@rysch01-Legion-Pro-5-2404:~/Projects/teleoperation_spot/system_ws$ cat src/orbslam3_ros2/config/xtionA_rgbd.yaml
%YAML:1.0

#--------------------------------------------------------------------------------------------
# Camera Parameters. Adjust them!
#--------------------------------------------------------------------------------------------
File.version: "1.0"

Camera.type: "PinHole"

# Camera calibration and distortion parameters (OpenCV) 
Camera1.fx: 517.306408
Camera1.fy: 516.469215
Camera1.cx: 318.643040
Camera1.cy: 255.313989

Camera1.k1: 0.262383
Camera1.k2: -0.953104
Camera1.p1: -0.005358
Camera1.p2: 0.002628
Camera1.k3: 1.163314

Camera.width: 640
Camera.height: 480

# Camera frames per second 
Camera.fps: 30

# Color order of the images (0: BGR, 1: RGB. It is ignored if images are grayscale)
Camera.RGB: 1

# Close/Far threshold. Baseline times.
Stereo.ThDepth: 40.0
Stereo.b: 0.07732

# Depth map values factor
RGBD.DepthMapFactor: 5000.0 # 1.0 for ROS_bag

#--------------------------------------------------------------------------------------------
# ORB Parameters
#--------------------------------------------------------------------------------------------

# ORB Extractor: Number of features per image
ORBextractor.nFeatures: 1000

# ORB Extractor: Scale factor between levels in the scale pyramid 	
ORBextractor.scaleFactor: 1.2

# ORB Extractor: Number of levels in the scale pyramid	
ORBextractor.nLevels: 8

# ORB Extractor: Fast threshold
# Image is divided in a grid. At each cell FAST are extracted imposing a minimum response.
# Firstly we impose iniThFAST. If no corners are detected we impose a lower value minThFAST
# You can lower these values if your images have low contrast			
ORBextractor.iniThFAST: 20
ORBextractor.minThFAST: 7

#--------------------------------------------------------------------------------------------
# Viewer Parameters
#--------------------------------------------------------------------------------------------
Viewer.KeyFrameSize: 0.05
Viewer.KeyFrameLineWidth: 1.0
Viewer.GraphLineWidth: 0.9
Viewer.PointSize: 2.0
Viewer.CameraSize: 0.08
Viewer.CameraLineWidth: 3.0
Viewer.ViewpointX: 0.0
Viewer.ViewpointY: -0.7
Viewer.ViewpointZ: -1.8
Viewer.ViewpointF: 500.0

rysch01@rysch01-Legion-Pro-
The above are running or current settings

then I do this



rysch01@rysch01-Legion-Pro-5-2404:~/Projects/teleoperation_spot/system_ws$ # Terminal 1 – SLAM
cd ~/Projects/teleoperation_spot/system_ws
source /opt/ros/jazzy/setup.bash
source install/setup.bash

ros2 run orbslam3 rgbd \
  ~/Projects/teleoperation_spot/cpp/ORB_SLAM3/Vocabulary/ORBvoc.txt \
  ~/Projects/teleoperation_spot/system_ws/src/orbslam3_ros2/config/xtionA_rgbd.yaml \
  --ros-args \
  -r /camera/color/image_raw:=/camA/rgb/image_raw \
  -r /camera/aligned_depth_to_color/image_raw:=/camA/depth/image_raw \
  -r /camera/color/camera_info:=/camA/rgb/camera_info

ORB-SLAM3 Copyright (C) 2017-2020 Carlos Campos, Richard Elvira, Juan J. Gómez, José M.M. Montiel and Juan D. Tardós, University of Zaragoza.
ORB-SLAM2 Copyright (C) 2014-2016 Raúl Mur-Artal, José M.M. Montiel and Juan D. Tardós, University of Zaragoza.
This program comes with ABSOLUTELY NO WARRANTY;
This is free software, and you are welcome to redistribute it
under certain conditions. See LICENSE.txt.

Input sensor was set to: RGB-D
Loading settings from /home/rysch01/Projects/teleoperation_spot/system_ws/src/orbslam3_ros2/config/xtionA_rgbd.yaml
	-Loaded camera 1
Camera.newHeight optional parameter does not exist...
Camera.newWidth optional parameter does not exist...
	-Loaded image info
	-Loaded RGB-D calibration
	-Loaded ORB settings
Viewer.imageViewScale optional parameter does not exist...
	-Loaded viewer settings
System.LoadAtlasFromFile optional parameter does not exist...
System.SaveAtlasToFile optional parameter does not exist...
	-Loaded Atlas settings
System.thFarPoints optional parameter does not exist...
	-Loaded misc parameters
----------------------------------
SLAM settings: 
	-Camera 1 parameters (Pinhole): [ 517.306 516.469 318.643 255.314 ]
	-Camera 1 distortion parameters: [  0.262383 -0.953104 -0.005358 0.002628 1.16331 ]
	-Original image size: [ 640 , 480 ]
	-Current image size: [ 640 , 480 ]
	-Sequence FPS: 30
	-RGB-D depth map factor: 5000
	-Features per image: 1000
	-ORB scale factor: 1.2
	-ORB number of scales: 8
	-Initial FAST threshold: 20
	-Min FAST threshold: 7


Loading ORB Vocabulary. This could take a while...
Vocabulary loaded!

Initialization of Atlas from scratch 
Creation of new map with id: 0
Creation of new map with last KF id: 0
Seq. Name: 
There are 1 cameras in the atlas
Camera 0 is pinhole
Shutdown

Saving keyframe trajectory to KeyFrameTrajectory.txt ...
double free or corruption (out)
[ros2run]: Aborted
rysch01@rysch01-Legion-Pro-5-2404:~/Projects/tel

Give updates that can be done only in terminal eg sed



cd ~/Projects/teleoperation_spot/system_ws

sed -i '
s/^Camera1.fx:.*/Camera1.fx: 570.3422241210938/
s/^Camera1.fy:.*/Camera1.fy: 570.3422241210938/
s/^Camera1.cx:.*/Camera1.cx: 319.5/
s/^Camera1.cy:.*/Camera1.cy: 239.5/
s/^Camera1.k1:.*/Camera1.k1: 0.0/
s/^Camera1.k2:.*/Camera1.k2: 0.0/
s/^Camera1.p1:.*/Camera1.p1: 0.0/
s/^Camera1.p2:.*/Camera1.p2: 0.0/
s/^Camera1.k3:.*/Camera1.k3: 0.0/
s/^RGBD.DepthMapFactor:.*/RGBD.DepthMapFactor: 1000.0/
' src/orbslam3_ros2/config/xtionA_rgbd.yaml



cd ~/Projects/teleoperation_spot/system_ws

source /opt/ros/jazzy/setup.bash
source install/setup.bash

ros2 run orbslam3 rgbd \
  ~/Projects/teleoperation_spot/cpp/ORB_SLAM3/Vocabulary/ORBvoc.txt \
  ~/Projects/teleoperation_spot/system_ws/src/orbslam3_ros2/config/xtionA_rgbd.yaml \
  --ros-args \
  -r /camera/color/image_raw:=/camA/rgb/image_raw \
  -r /camera/aligned_depth_to_color/image_raw:=/camA/depth/image \
  -r /camera/color/camera_info:=/camA/rgb/camera_info


if need to swap scale
cd ~/Projects/teleoperation_spot/system_ws

sed -i 's/^RGBD.DepthMapFactor:.*/RGBD.DepthMapFactor: 1000.0/' \
  src/orbslam3_ros2/config/xtionA_rgbd.yaml


cd ~/Projects/teleoperation_spot/system_ws
source /opt/ros/jazzy/setup.bash
source install/setup.bash

ros2 run orbslam3 rgbd -- \
  ~/Projects/teleoperation_spot/cpp/ORB_SLAM3/Vocabulary/ORBvoc.txt \
  ~/Projects/teleoperation_spot/system_ws/src/orbslam3_ros2/config/xtionA_rgbd.yaml \
  --ros-args \
  -r /camera/color/image_raw:=/camA/rgb/image_raw \
  -r /camera/aligned_depth_to_color/image_raw:=/camA/depth/image \
  -r /camera/color/camera_info:=/camA/rgb/camera_info




cd ~/Projects/teleoperation_spot/system_ws

ls -lh KeyFrameTrajectory.txt
head -n 5 KeyFrameTrajectory.txt
tail -n 5 KeyFrameTrajectory.txt
cd ~/Projects/teleoperation_spot/system_ws

# Comment out the trajectory-save line wherever it appears in the orbslam3_ros2 sources
grep -Rl "KeyFrameTrajectory.txt" src/orbslam3_ros2 \
  | xargs -I{} sed -i 's/SLAM.SaveKeyFrameTrajectoryTUM("KeyFrameTrajectory.txt");/\/\/SLAM.SaveKeyFrameTrajectoryTUM("KeyFrameTrajectory.txt");/' {}

















[ros2run]: Aborted
rysch01@rysch01-Legion-Pro-5-2404:~/Projects/teleoperation_spot/system_ws$ ros2 topic hz /camA/rgb/image_raw
ros2 topic hz /camA/depth/image
average rate: 26.969
	min: 0.022s max: 0.099s std dev: 0.01491s window: 28
average rate: 27.924
	min: 0.022s max: 0.099s std dev: 0.01210s window: 57
average rate: 27.996
	min: 0.020s max: 0.099s std dev: 0.01182s window: 86
^C^Crysch01@rysch01-Legion-Pro-5-2404:~/Projects/teleoperation_spot/system_ws$ c^C k 
rysch01@rysch01-Legion-Pro-5-2404:~/Projects/teleoperation_spot/system_ws$ cat KeyFrameTrajectory.txt 
rysch01@rysch01-Legion-Pro-5-2404:~/Projects/teleoperation_spot/system_ws$ 
rysch01@rysch01-Legion-Pro-5-2404:~/Projects/teleoperation_spot/system_ws$ 
rysch01@rysch01-Legion-Pro-5-2404:~/Projects/teleoperation_spot/system_ws$ 
rysch01@rysch01-Legion-Pro-5-2404:~/Projects/teleoperation_spot/system_ws$ 
rysch01@rysch01-Legion-Pro-5-2404:~/Projects/teleoperation_spot/system_ws$ 
rysch01@rysch01-Legion-Pro-5-2404:~/Projects/teleoperation_spot/system_ws$ cd ~/Projects/teleoperation_spot/system_ws

ls -lh KeyFrameTrajectory.txt
head -n 5 KeyFrameTrajectory.txt
tail -n 5 KeyFrameTrajectory.txt
-rw-rw-r-- 1 rysch01 rysch01 0 Dec  4 18:02 KeyFrameTrajectory.txt
rysch01@rysch01-Legion-Pro-5-2404:~/Projects/teleoperation_spot/system_ws$ cd ~/Projects/teleoperation_spot/system_ws

# Comment out the trajectory-save line wherever it appears in the orbslam3_ros2 sources
grep -Rl "KeyFrameTrajectory.txt" src/orbslam3_ros2 \
  | xargs -I{} sed -i 's/SLAM.SaveKeyFrameTrajectoryTUM("KeyFrameTrajectory.txt");/\/\/SLAM.SaveKeyFrameTrajectoryTUM("KeyFrameTrajectory.txt");/' {}
rysch01@rysch01-Legion-Pro-5-2404:~/Projects/teleoperation_spot/system_ws$ colcon build --packages-select orbslam3
source /opt/ros/jazzy/setup.bash
source install/setup.bash
Starting >>> orbslam3




/home/rysch01/Projects/teleoperation_spot/cpp/ORB_SLAM3/include/CameraModels/Pinhole.h:86:51: warning: unused parameter ‘x3Dtriangulated’ [-Wunused-parameter]
   86 |                                  Eigen::Vector3f& x3Dtriangulated) { return false;}
      |                                  ~~~~~~~~~~~~~~~~~^~~~~~~~~~~~~~~
In file included from /home/rysch01/Projects/teleoperation_spot/cpp/ORB_SLAM3/include/Atlas.h:27:
/home/rysch01/Projects/teleoperation_spot/cpp/ORB_SLAM3/include/CameraModels/KannalaBrandt8.h: In constructor ‘ORB_SLAM3::KannalaBrandt8::KannalaBrandt8(std::vector<float>)’:
/home/rysch01/Projects/teleoperation_spot/cpp/ORB_SLAM3/include/CameraModels/KannalaBrandt8.h:102:21: warning: ‘ORB_SLAM3::KannalaBrandt8::precision’ will be initialized after [-Wreorder]
  102 |         const float precision;
      |                     ^~~~~~~~~
/home/rysch01/Projects/teleoperation_spot/cpp/ORB_SLAM3/include/CameraModels/KannalaBrandt8.h:88:26: warning:   ‘std::vector<int> ORB_SLAM3::KannalaBrandt8::mvLappingArea’ [-Wreorder]
   88 |         std::vector<int> mvLappingArea;
      |                          ^~~~~~~~~~~~~
/home/rysch01/Projects/teleoperation_spot/cpp/ORB_SLAM3/include/CameraModels/KannalaBrandt8.h:47:9: warning:   when initialized here [-Wreorder]
   47 |         KannalaBrandt8(const std::vector<float> _vParameters) : GeometricCamera(_vParameters), precision(1e-6), mvLappingArea(2,0) ,tvr(nullptr) {
      |         ^~~~~~~~~~~~~~
/home/rysch01/Projects/teleoperation_spot/cpp/ORB_SLAM3/include/CameraModels/KannalaBrandt8.h: In constructor ‘ORB_SLAM3::KannalaBrandt8::KannalaBrandt8(std::vector<float>, float)’:
/home/rysch01/Projects/teleoperation_spot/cpp/ORB_SLAM3/include/CameraModels/KannalaBrandt8.h:102:21: warning: ‘ORB_SLAM3::KannalaBrandt8::precision’ will be initialized after [-Wreorder]
  102 |         const float precision;
      |                     ^~~~~~~~~
/home/rysch01/Projects/teleoperation_spot/cpp/ORB_SLAM3/include/CameraModels/KannalaBrandt8.h:88:26: warning:   ‘std::vector<int> ORB_SLAM3::KannalaBrandt8::mvLappingArea’ [-Wreorder]
   88 |         std::vector<int> mvLappingArea;
      |                          ^~~~~~~~~~~~~
/home/rysch01/Projects/teleoperation_spot/cpp/ORB_SLAM3/include/CameraModels/KannalaBrandt8.h:53:9: warning:   when initialized here [-Wreorder]
   53 |         KannalaBrandt8(const std::vector<float> _vParameters, const float _precision) : GeometricCamera(_vParameters),
      |         ^~~~~~~~~~~~~~
/home/rysch01/Projects/teleoperation_spot/cpp/ORB_SLAM3/include/CameraModels/KannalaBrandt8.h: In constructor ‘ORB_SLAM3::KannalaBrandt8::KannalaBrandt8(ORB_SLAM3::KannalaBrandt8*)’:
/home/rysch01/Projects/teleoperation_spot/cpp/ORB_SLAM3/include/CameraModels/KannalaBrandt8.h:102:21: warning: ‘ORB_SLAM3::KannalaBrandt8::precision’ will be initialized after [-Wreorder]
  102 |         const float precision;
      |                     ^~~~~~~~~
/home/rysch01/Projects/teleoperation_spot/cpp/ORB_SLAM3/include/CameraModels/KannalaBrandt8.h:88:26: warning:   ‘std::vector<int> ORB_SLAM3::KannalaBrandt8::mvLappingArea’ [-Wreorder]
   88 |         std::vector<int> mvLappingArea;
      |                          ^~~~~~~~~~~~~
/home/rysch01/Projects/teleoperation_spot/cpp/ORB_SLAM3/include/CameraModels/KannalaBrandt8.h:59:9: warning:   when initialized here [-Wreorder]
   59 |         KannalaBrandt8(KannalaBrandt8* pKannala) : GeometricCamera(pKannala->mvParameters), precision(pKannala->precision), mvLappingArea(2,0) ,tvr(nullptr) {
      |         ^~~~~~~~~~~~~~
---
Finished <<< orbslam3 [13.0s]

Summary: 1 package finished [13.1s]
  1 package had stderr output: orbslam3
rysch01@rysch01-Legion-Pro-5-2404:~/Projects/teleoperation_spot/system_ws$ source /opt/ros/jazzy/setup.bash
source install/setup.bash
rysch01@rysch01-Legion-Pro-5-2404:~/Projects/teleoperation_spot/system_ws$ ros2 run orbslam3 rgbd -- \
  ~/Projects/teleoperation_spot/cpp/ORB_SLAM3/Vocabulary/ORBvoc.txt \
  ~/Projects/teleoperation_spot/system_ws/src/orbslam3_ros2/config/xtionA_rgbd.yaml \
  --ros-args \
  -r /camera/color/image_raw:=/camA/rgb/image_raw \
  -r /camera/aligned_depth_to_color/image_raw:=/camA/depth/image \
  -r /camera/color/camera_info:=/camA/rgb/camera_info

ORB-SLAM3 Copyright (C) 2017-2020 Carlos Campos, Richard Elvira, Juan J. Gómez, José M.M. Montiel and Juan D. Tardós, University of Zaragoza.
ORB-SLAM2 Copyright (C) 2014-2016 Raúl Mur-Artal, José M.M. Montiel and Juan D. Tardós, University of Zaragoza.
This program comes with ABSOLUTELY NO WARRANTY;
This is free software, and you are welcome to redistribute it
under certain conditions. See LICENSE.txt.

Input sensor was set to: RGB-D
Loading settings from /home/rysch01/Projects/teleoperation_spot/system_ws/src/orbslam3_ros2/config/xtionA_rgbd.yaml
	-Loaded camera 1
Camera.newHeight optional parameter does not exist...
Camera.newWidth optional parameter does not exist...
	-Loaded image info
	-Loaded RGB-D calibration
	-Loaded ORB settings
Viewer.imageViewScale optional parameter does not exist...
	-Loaded viewer settings
System.LoadAtlasFromFile optional parameter does not exist...
System.SaveAtlasToFile optional parameter does not exist...
	-Loaded Atlas settings
System.thFarPoints optional parameter does not exist...
	-Loaded misc parameters
----------------------------------
SLAM settings: 
	-Camera 1 parameters (Pinhole): [ 570.342 570.342 319.5 239.5 ]
	-Camera 1 distortion parameters: [  0 0 0 0 0 ]
	-Original image size: [ 640 , 480 ]
	-Current image size: [ 640 , 480 ]
	-Sequence FPS: 30
	-RGB-D depth map factor: 1000
	-Features per image: 1000
	-ORB scale factor: 1.2
	-ORB number of scales: 8
	-Initial FAST threshold: 20
	-Min FAST threshold: 7


Loading ORB Vocabulary. This could take a while...
Vocabulary loaded!

Initialization of Atlas from scratch 
Creation of new map with id: 0
Creation of new map with last KF id: 0
Seq. Name: 
There are 1 cameras in the atlas
Camera 0 is pinhole
Shutdown

Saving keyframe trajectory to KeyFrameTrajectory.txt ...
double free or corruption (out)
[ros2run]: Aborted
rysch01@rysch01-Legion-Pro-5-2404:~/Projects/teleoperation_spot/system_ws$ ^C
rysch01@rysch01-Legion-Pro-5-2404:~/Projects/teleoperation_spot/system_ws$ ^C
rysch01@rysch01-Legion-Pro-5-2404:~/Projects/teleoperation_spot/system_ws



ration_spot/system_ws$ 
rysch01@rysch01-Legion-Pro-5-2404:~/Projects/teleoperation_spot/system_ws$ ^C
rysch01@rysch01-Legion-Pro-5-2404:~/Projects/teleoperation_spot/system_ws$ grep -Rl "KeyFrameTrajectory.txt" 
install/orbslam3/lib/orbslam3/stereo-inertial
install/orbslam3/lib/orbslam3/rgbd
install/orbslam3/lib/orbslam3/stereo
install/orbslam3/lib/orbslam3/mono
build/orbslam3/stereo-inertial
build/orbslam3/rgbd
build/orbslam3/stereo
build/orbslam3/mono
build/orbslam3/CMakeFiles/mono.dir/src/monocular/monocular-slam-node.cpp.o
build/orbslam3/CMakeFiles/rgbd.dir/src/rgbd/rgbd-slam-node.cpp.o
build/orbslam3/CMakeFiles/stereo.dir/src/stereo/stereo-slam-node.cpp.o
build/orbslam3/CMakeFiles/stereo-inertial.dir/src/stereo-inertial/stereo-inertial-node.cpp.o
src/orbslam3_ros2/src/stereo-inertial/stereo-inertial-node.cpp
src/orbslam3_ros2/src/rgbd/rgbd-slam-node.cpp
src/orbslam3_ros2/src/monocular/monocular-slam-node.cpp
src/orbslam3_ros2/src/stereo/stereo-slam-node.cpp
rysch01@rysch01-Legion-Pro-5-2404:~/Projects/teleoperation_spot/system_ws$ grep -R "KeyFrameTrajectory.txt" 
grep: install/orbslam3/lib/orbslam3/stereo-inertial: binary file matches
grep: install/orbslam3/lib/orbslam3/rgbd: binary file matches
grep: install/orbslam3/lib/orbslam3/stereo: binary file matches
grep: install/orbslam3/lib/orbslam3/mono: binary file matches
grep: build/orbslam3/stereo-inertial: binary file matches
grep: build/orbslam3/rgbd: binary file matches
grep: build/orbslam3/stereo: binary file matches
grep: build/orbslam3/mono: binary file matches
grep: build/orbslam3/CMakeFiles/mono.dir/src/monocular/monocular-slam-node.cpp.o: binary file matches
grep: build/orbslam3/CMakeFiles/rgbd.dir/src/rgbd/rgbd-slam-node.cpp.o: binary file matches
grep: build/orbslam3/CMakeFiles/stereo.dir/src/stereo/stereo-slam-node.cpp.o: binary file matches
grep: build/orbslam3/CMakeFiles/stereo-inertial.dir/src/stereo-inertial/stereo-inertial-node.cpp.o: binary file matches
src/orbslam3_ros2/src/stereo-inertial/stereo-inertial-node.cpp:    SLAM_->SaveKeyFrameTrajectoryTUM("KeyFrameTrajectory.txt");
src/orbslam3_ros2/src/rgbd/rgbd-slam-node.cpp:    m_SLAM->SaveKeyFrameTrajectoryTUM("KeyFrameTrajectory.txt");
src/orbslam3_ros2/src/monocular/monocular-slam-node.cpp:    m_SLAM->SaveKeyFrameTrajectoryTUM("KeyFrameTrajectory.txt");
src/orbslam3_ros2/src/stereo/stereo-slam-node.cpp:    m_SLAM->SaveKeyFrameTrajectoryTUM("KeyFrameTrajectory.txt");
rysch01@rysch01-Legion-Pro-5-2404:~/Projects/teleoperation_spot/system_ws$ 



cd ~/Projects/teleoperation_spot/system_ws

# Comment out all SaveKeyFrameTrajectoryTUM calls in the ROS2 wrappers
for f in \
  src/orbslam3_ros2/src/monocular/monocular-slam-node.cpp \
  src/orbslam3_ros2/src/stereo/stereo-slam-node.cpp \
  src/orbslam3_ros2/src/rgbd/rgbd-slam-node.cpp \
  src/orbslam3_ros2/src/stereo-inertial/stereo-inertial-node.cpp
do
  echo "Patching $f"
  sed -i 's/\(.*SaveKeyFrameTrajectoryTUM("KeyFrameTrajectory.txt");\)/\/\/ \1/' "$f"
done


cd ~/Projects/teleoperation_spot/system_ws

# Comment out all SaveKeyFrameTrajectoryTUM calls in the ROS2 wrappers
for f in \
  src/orbslam3_ros2/src/monocular/monocular-slam-node.cpp \
  src/orbslam3_ros2/src/stereo/stereo-slam-node.cpp \
  src/orbslam3_ros2/src/rgbd/rgbd-slam-node.cpp \
  src/orbslam3_ros2/src/stereo-inertial/stereo-inertial-node.cpp
do
  echo "Patching $f"
  sed -i 's/\(.*SaveKeyFrameTrajectoryTUM("KeyFrameTrajectory.txt");\)/\/\/ \1/' "$f"
done


cd ~/Projects/teleoperation_spot/system_ws

rm -rf build/orbslam3 install/orbslam3 log/latest/orbslam3*

colcon build --packages-select orbslam3


source /opt/ros/jazzy/setup.bash
source install/setup.bash
ros2 pkg list | grep orbslam3


cd ~/Projects/teleoperation_spot/cpp/ORB_SLAM3

ls -lh lib


cd ~/Projects/teleoperation_spot/system_ws

# Add ORB-SLAM3 lib dir for this shell session
export LD_LIBRARY_PATH=$LD_LIBRARY_PATH:$HOME/Projects/teleoperation_spot/cpp/ORB_SLAM3/lib

# Optionally verify that the rgbd binary now sees the lib
ldd install/orbslam3/lib/orbslam3/rgbd | grep ORB


cd ~/Projects/teleoperation_spot/system_ws
sed -i 's/ORB_SLAM3::System::RGBD, true)/ORB_SLAM3::System::RGBD, false)/' \
  src/orbslam3_ros2/src/rgbd/rgbd-slam-node.cpp
sed -i 's/\(.*->Shutdown();\)/\/\/ \1/' \
  src/orbslam3_ros2/src/rgbd/rgbd-slam-node.cpp




source /opt/ros/jazzy/setup.bash
source install/setup.bash
export LD_LIBRARY_PATH=$LD_LIBRARY_PATH:$HOME/Projects/teleoperation_spot/cpp/ORB_SLAM3/lib
cd ~/Projects/teleoperation_spot/system_ws

ros2 run orbslam3 rgbd -- \
  ~/Projects/teleoperation_spot/cpp/ORB_SLAM3/Vocabulary/ORBvoc.txt \
  ~/Projects/teleoperation_spot/system_ws/src/orbslam3_ros2/config/xtionA_rgbd.yaml \
  --ros-args \
  -r /camera/color/image_raw:=/camA/rgb/image_raw \
  -r /camera/aligned_depth_to_color/image_raw:=/camA/depth/image \
  -r /camera/color/camera_info:=/camA/rgb/camera_info



eoperation_spot/system_ws$ cd ~/Projects/teleoperation_spot/cpp/ORB_SLAM3

ls -lh lib
total 5.0M
-rwxrwxr-x 1 rysch01 rysch01 5.0M Dec  3 16:42 libORB_SLAM3.so
rysch01@rysch01-Legion-Pro-5-2404:~/Projects/teleoperation_spot/cpp/ORB_SLAM3$ 



cd ~/Projects/teleoperation_spot/system_ws

# Base ROS and workspace overlay
source /opt/ros/jazzy/setup.bash
source install/setup.bash

# Add ORB_SLAM3 lib dir for this shell
export LD_LIBRARY_PATH=$HOME/Projects/teleoperation_spot/cpp/ORB_SLAM3/lib:$LD_LIBRARY_PATH

# Sanity check: does rgbd see the library now?
ldd install/orbslam3/lib/orbslam3/rgbd | grep ORB_SLAM3



ros2 run orbslam3 rgbd -- \
  ~/Projects/teleoperation_spot/cpp/ORB_SLAM3/Vocabulary/ORBvoc.txt \
  ~/Projects/teleoperation_spot/system_ws/src/orbslam3_ros2/config/xtionA_rgbd.yaml \
  --ros-args \
  -r /camera/color/image_raw:=/camA/rgb/image_raw \
  -r /camera/aligned_depth_to_color/image_raw:=/camA/depth/image \
  -r /camera/color/camera_info:=/camA/rgb/camera_info



wjat jave we removed that didnt fix this. things like trajectory were disable if those didnt fix it, should we just bring those back and ask claude to fix it? What dow e need to bring back and how to do? What files got swapped? reminder i do need to end with trajectory/ shpu;d we continue investigating this path?




cd ~/Projects/teleoperation_spot/system_ws

# Un-comment trajectory save calls in all slam-node wrappers
sed -i 's|//[[:space:]]*\(.*SaveKeyFrameTrajectoryTUM("KeyFrameTrajectory.txt");\)|\1|' \
  src/orbslam3_ros2/src/monocular/monocular-slam-node.cpp \
  src/orbslam3_ros2/src/stereo/stereo-slam-node.cpp \
  src/orbslam3_ros2/src/rgbd/rgbd-slam-node.cpp \
  src/orbslam3_ros2/src/stereo-inertial/stereo-inertial-node.cpp

# Verify
grep -n "SaveKeyFrameTrajectoryTUM" src/orbslam3_ros2/src/*/*-slam-node.cpp
rm -rf build/orbslam3 install/orbslam3 log/latest/orbslam3*
colcon build --packages-select orbslam3

source /opt/ros/jazzy/setup.bash
source install/setup.bash
























Short answer: **almost everything is restored**, but there is **one important line still commented out** that you probably want back before handing this to Claude.

From your grep:

```bash
grep -n "SaveKeyFrameTrajectoryTUM" src/orbslam3_ros2/src/*/*-slam-node.cpp
# shows the bare call, no leading //
src/orbslam3_ros2/src/monocular/monocular-slam-node.cpp:25:m_SLAM->SaveKeyFrameTrajectoryTUM("KeyFrameTrajectory.txt");
src/orbslam3_ros2/src/rgbd/rgbd-slam-node.cpp:25:m_SLAM->SaveKeyFrameTrajectoryTUM("KeyFrameTrajectory.txt");
src/orbslam3_ros2/src/stereo/stereo-slam-node.cpp:64:m_SLAM->SaveKeyFrameTrajectoryTUM("KeyFrameTrajectory.txt");
```

✅ All the **trajectory saves are restored**.

But:

```bash
grep -R "Shutdown();" -n src/orbslam3_ros2
src/orbslam3_ros2/src/stereo-inertial/stereo-inertial-node.cpp:74:    SLAM_->Shutdown();
src/orbslam3_ros2/src/rgbd/rgbd-slam-node.cpp:22://     m_SLAM->Shutdown();
src/orbslam3_ros2/src/monocular/monocular-slam-node.cpp:22:    m_SLAM->Shutdown();
src/orbslam3_ros2/src/stereo/stereo-slam-node.cpp:61:    m_SLAM->Shutdown();
```

👉 **Only the RGB-D node’s `Shutdown()` is still commented**. That’s different from upstream and different from the mono/stereo nodes.

I’d restore that one line so your tree is closer to “vanilla + necessary build fixes”, which is better for Claude.

Run this once:

```bash
cd ~/Projects/teleoperation_spot/system_ws

sed -i 's|//\s*m_SLAM->Shutdown();|    m_SLAM->Shutdown();|' \
  src/orbslam3_ros2/src/rgbd/rgbd-slam-node.cpp

# sanity check
grep -R "Shutdown();" -n src/orbslam3_ros2
```

You want to see:

```text
src/orbslam3_ros2/src/rgbd/rgbd-slam-node.cpp:22:    m_SLAM->Shutdown();
```

At that point:

* `SaveKeyFrameTrajectoryTUM` calls ✅ present.
* All `Shutdown()` calls ✅ present.
* `System::RGBD` still uses `visualization` flag, not forced true/false by sed ✅.
* All build-related sed patches (C++14, includes, FindORB_SLAM3, etc.) ✅ in place and needed.

So yes: **once you run that `sed` above, everything important is “returned”** and you don’t need Claude to chase your earlier sed experiments. He can just debug the actual double-free.

---

## Handoff for Claude (you’ll paste this to him)

You can paste something like this as your next message to Claude:

That’s it — with that last `Shutdown()` restored, all of the earlier sed experiments that matter are back in a sane state, and you can treat this as “upstream ORB-SLAM3 + necessary ROS2 build patches + an early double-free bug to find.”
















---

**Context / Goal**

* Project root:
  `~/Projects/teleoperation_spot`
* ROS 2 distro: **Jazzy** on Ubuntu (laptop, no container).
* I have two ASUS Xtion RGB-D cameras (`camA`, `camB`) publishing via a ROS 2 driver in `system_ws/src/ros2_asus_xtion` + `xtion_bringup`.
* Goal:

  1. Run **ORB-SLAM3 RGB-D** on `camA` (and later `camB`).
  2. Get keyframe trajectories out (eventually for multi-camera extrinsics).
  3. Fix a **double free / corruption** that happens right after “There are 1 cameras in the atlas / Camera 0 is pinhole…”.

Everything below is from a **local ROS 2 workspace**, not Docker.

---

### Project layout

```text
~/Projects/teleoperation_spot/
  cpp/
    ORB_SLAM3/          # upstream ORB-SLAM3, built, has libORB_SLAM3.so
    OpenNI2/            # OpenNI2 stack for the Xtions
  system_ws/
    src/
      orbslam3_ros2/    # ROS 2 wrapper for ORB-SLAM3
      ros2_asus_xtion/
      xtion_bringup/
    build/
    install/
    log/
  docs/
    setup/
      8_orbslam3_w_xtion_rosvbags   # my running log of commands
```

---

### What currently works

From a clean shell:

```bash
cd ~/Projects/teleoperation_spot/system_ws
source /opt/ros/jazzy/setup.bash
source install/setup.bash

ros2 pkg list | grep orbslam3   # → orbslam3
```

Camera topics (from live or rosbag):

```bash
ros2 topic list
# includes:
# /camA/rgb/image_raw
# /camA/rgb/camera_info
# /camA/depth/image
# /camA/depth/camera_info
# same for /camB/...
```

Camera intrinsics for both cams (they’re identical):

```bash
ros2 topic echo /camA/rgb/camera_info --once
# height: 480, width: 640
# K:
#   fx = 570.3422241210938
#   fy = 570.3422241210938
#   cx = 319.5
#   cy = 239.5
# distortion model: plumb_bob, all zeros
```

ORB-SLAM3 core library exists and links fine:

```bash
cd ~/Projects/teleoperation_spot/cpp/ORB_SLAM3
ls -lh lib/libORB_SLAM3.so
# -rwxrwxr-x 1 rysch01 rysch01 5.0M Dec  3 16:42 libORB_SLAM3.so

ldd lib/libORB_SLAM3.so | grep g2o
# Thirdparty/g2o/lib/libg2o.so is found
```

Vocabulary is present and valid:

```bash
cd ~/Projects/teleoperation_spot/cpp/ORB_SLAM3/Vocabulary
ls -lh ORBvoc.txt
# 139M, downloaded from ORB-SLAM2 repo
```

---

### RGB-D config to use (Xtion A)

Use this file for camA:

```bash
cat ~/Projects/teleoperation_spot/system_ws/src/orbslam3_ros2/config/xtionA_rgbd.yaml
```

Contents (key bits):

```yaml
%YAML:1.0
File.version: "1.0"
Camera.type: "PinHole"

# Xtion A intrinsics (from /camA/rgb/camera_info)
Camera1.fx: 570.3422241210938
Camera1.fy: 570.3422241210938
Camera1.cx: 319.5
Camera1.cy: 239.5

Camera1.k1: 0.0
Camera1.k2: 0.0
Camera1.p1: 0.0
Camera1.p2: 0.0
Camera1.k3: 0.0

Camera.width: 640
Camera.height: 480
Camera.fps: 30
Camera.RGB: 1

Stereo.ThDepth: 40.0
Stereo.b: 0.07732

# depth_raw is in meters -> use 1000 (see below)
RGBD.DepthMapFactor: 1000.0

ORBextractor.nFeatures: 1000
ORBextractor.scaleFactor: 1.2
ORBextractor.nLevels: 8
ORBextractor.iniThFAST: 20
ORBextractor.minThFAST: 7

Viewer.KeyFrameSize: 0.05
Viewer.ViewpointF: 500.0
```

I edited `RGBD.DepthMapFactor` to **1000.0** because `/camA/depth/image` encodes depth in meters * 1000 (checked via echo).

---

### How I run it

With a bag playing:

```bash
cd ~/Projects/teleoperation_spot/system_ws
source /opt/ros/jazzy/setup.bash
source install/setup.bash

# Terminal 1 – play bag (loop)
ros2 bag play xtion_20251203_154457.bag/ --loop

# Terminal 2 – run ORB-SLAM3 RGBD
cd ~/Projects/teleoperation_spot/system_ws
source /opt/ros/jazzy/setup.bash
source install/setup.bash

ros2 run orbslam3 rgbd -- \
  ~/Projects/teleoperation_spot/cpp/ORB_SLAM3/Vocabulary/ORBvoc.txt \
  ~/Projects/teleoperation_spot/system_ws/src/orbslam3_ros2/config/xtionA_rgbd.yaml \
  --ros-args \
  -r /camera/color/image_raw:=/camA/rgb/image_raw \
  -r /camera/aligned_depth_to_color/image_raw:=/camA/depth/image \
  -r /camera/color/camera_info:=/camA/rgb/camera_info
```

---

### Current symptoms

On every run of the RGB-D node I see:

```text
ORB-SLAM3 Copyright ...
Input sensor was set to: RGB-D
Loading settings from .../xtionA_rgbd.yaml
  -Loaded camera 1
  -Loaded image info
  -Loaded RGB-D calibration
  -Loaded ORB settings
  -Loaded viewer settings
  -Loaded Atlas settings
  -Loaded misc parameters
----------------------------------
SLAM settings:
  Camera 1 parameters (Pinhole): [ 570.342 570.342 319.5 239.5 ]
  Camera 1 distortion parameters: [  0 0 0 0 0 ]
  Original image size: [ 640 , 480 ]
  Current image size: [ 640 , 480 ]
  Sequence FPS: 30
  RGB-D depth map factor: 1000
  ...

Loading ORB Vocabulary. This could take a while...
Vocabulary loaded!

Initialization of Atlas from scratch
Creation of new map with id: 0
Creation of new map with last KF id: 0
Seq. Name:
There are 1 cameras in the atlas
Camera 0 is pinhole
double free or corruption (out)
[ros2run]: Aborted
```

Behavior:

* Pangolin window *sometimes* flashes open then closes immediately.
* `KeyFrameTrajectory.txt` is **zero-length** or not written (depending on whether SaveKeyFrameTrajectoryTUM was commented).
* Crash happens **immediately after** “Camera 0 is pinhole”, before any tracking output.

So we’re failing very early, during init or first frame / viewer setup.

---

### What I changed in `orbslam3_ros2` (build fixes that should stay)

All these are already applied and are **needed** for Jazzy:

1. Switched `-std=c++11` → `-std=c++14` across the wrapper.

2. Replaced `monotonic_clock` with `steady_clock`.

3. Patched `CMakeModules/FindORB_SLAM3.cmake` to:

   ```cmake
   set(ORB_SLAM3_ROOT_DIR "/home/rysch01/Projects/teleoperation_spot/cpp/ORB_SLAM3")
   ```

4. Updated includes to `cv_bridge/cv_bridge.hpp`.

5. Added OpenCV + Pangolin include directories in `CMakeLists.txt`.

6. Ensured `ament_target_dependencies` includes `cv_bridge`, `OpenCV`, `Pangolin`, `ORB_SLAM3` where appropriate.

7. Added `target_link_libraries(... ${OpenCV_LIBRARIES})` for all four executables.

8. Added Sophus include dir: `${ORB_SLAM3_ROOT_DIR}/Thirdparty/Sophus`.

---

### Runtime-related code that **is now restored to normal**

I previously experimented with:

* Commenting out `SaveKeyFrameTrajectoryTUM("KeyFrameTrajectory.txt")`.
* Commenting out `m_SLAM->Shutdown()` in the wrappers.
* Changing `ORB_SLAM3::System::RGBD, true)` to `false`.

As of now:

```bash
# trajectory saving is ON
grep -n "SaveKeyFrameTrajectoryTUM" src/orbslam3_ros2/src/*/*-slam-node.cpp
src/orbslam3_ros2/src/monocular/monocular-slam-node.cpp:25:m_SLAM->SaveKeyFrameTrajectoryTUM("KeyFrameTrajectory.txt");
src/orbslam3_ros2/src/rgbd/rgbd-slam-node.cpp:25:m_SLAM->SaveKeyFrameTrajectoryTUM("KeyFrameTrajectory.txt");
src/orbslam3_ros2/src/stereo/stereo-slam-node.cpp:64:m_SLAM->SaveKeyFrameTrajectoryTUM("KeyFrameTrajectory.txt");

# Shutdown calls:
grep -R "Shutdown();" -n src/orbslam3_ros2
src/orbslam3_ros2/src/stereo-inertial/stereo-inertial-node.cpp:74:    SLAM_->Shutdown();
src/orbslam3_ros2/src/rgbd/rgbd-slam-node.cpp:22:    m_SLAM->Shutdown();   # ← restored
src/orbslam3_ros2/src/monocular/monocular-slam-node.cpp:22:    m_SLAM->Shutdown();
src/orbslam3_ros2/src/stereo/stereo-slam-node.cpp:61:    m_SLAM->Shutdown();

# RGBD System construction:
grep -R "System::RGBD" -n src/orbslam3_ros2
src/orbslam3_ros2/src/rgbd/rgbd.cpp:25:    ORB_SLAM3::System SLAM(argv[1], argv[2], ORB_SLAM3::System::RGBD, visualization);
```

So the wrappers are back to “normal” behavior (shutdown + trajectory save) with the **only differences vs upstream being CMake / includes**.

---

### What I’d like you (Claude) to do

1. **Initialize a git repo** at the project root and capture the current state:

   ```bash
   cd ~/Projects/teleoperation_spot

   git init
   git add -A
   git commit -m "Initial full snapshot including ORB_SLAM3 core, ROS2 wrappers, Xtion bringup"
   ```

   You can then add a `.gitignore` with at least:

   ```gitignore
   # ROS2 build / install / logs
   system_ws/build/
   system_ws/install/
   system_ws/log/

   # CMake build dirs elsewhere
   cpp/**/build/
   cpp/**/CMakeFiles/
   cpp/**/CMakeCache.txt

   # Bag files
   *.db3
   *.bag
   xtion_20*.bag/

   # Editor/OS
   .vscode/
   .idea/
   *~
   .DS_Store
   ```

2. **Debug the double free / corruption**, with all sed experiments essentially “normalized” already:

   * Run `ros2 run orbslam3 rgbd ...` under `gdb`, get a full backtrace.
   * Check Pangolin viewer initialization and shutdown paths.
   * Check destructor / ownership patterns for Atlas, Map, Viewer.
   * Confirm `libORB_SLAM3.so` and the ROS2 nodes all use the same `libstdc++`.
   * If helpful, compare `orbslam3_ros2` to its upstream repo and isolate diffs.

3. Please **copy all terminal I/O** you use during debugging into a note (or even into `docs/setup/9_orbslam3_debug_log`), so I can replay/understand your steps later.

The config you should focus on is:

* `xtionA_rgbd.yaml` (current and correct)
* `xtionB_rgbd.yaml` is still the older, hand-written version and should be updated *after* the RGB-D path is stable.

---













---

**Context / Goal**

* Project root:
  `~/Projects/teleoperation_spot`
* ROS 2 distro: **Jazzy** on Ubuntu (laptop, no container).
* I have two ASUS Xtion RGB-D cameras (`camA`, `camB`) publishing via a ROS 2 driver in `system_ws/src/ros2_asus_xtion` + `xtion_bringup`.
* Goal:

  1. Run **ORB-SLAM3 RGB-D** on `camA` (and later `camB`).
  2. Get keyframe trajectories out (eventually for multi-camera extrinsics).
  3. Fix a **double free / corruption** that happens right after “There are 1 cameras in the atlas / Camera 0 is pinhole…”.

Everything below is from a **local ROS 2 workspace**, not Docker.

---

### Project layout

```text
~/Projects/teleoperation_spot/
  cpp/
    ORB_SLAM3/          # upstream ORB-SLAM3, built, has libORB_SLAM3.so
    OpenNI2/            # OpenNI2 stack for the Xtions
  system_ws/
    src/
      orbslam3_ros2/    # ROS 2 wrapper for ORB-SLAM3
      ros2_asus_xtion/
      xtion_bringup/
    build/
    install/
    log/
  docs/
    setup/
      8_orbslam3_w_xtion_rosvbags   # my running log of commands
```

---

### What currently works

From a clean shell:

```bash
cd ~/Projects/teleoperation_spot/system_ws
source /opt/ros/jazzy/setup.bash
source install/setup.bash

ros2 pkg list | grep orbslam3   # → orbslam3
```

Camera topics (from live or rosbag):

```bash
ros2 topic list
# includes:
# /camA/rgb/image_raw
# /camA/rgb/camera_info
# /camA/depth/image
# /camA/depth/camera_info
# same for /camB/...
```

Camera intrinsics for both cams (they’re identical):

```bash
ros2 topic echo /camA/rgb/camera_info --once
# height: 480, width: 640
# K:
#   fx = 570.3422241210938
#   fy = 570.3422241210938
#   cx = 319.5
#   cy = 239.5
# distortion model: plumb_bob, all zeros
```

ORB-SLAM3 core library exists and links fine:

```bash
cd ~/Projects/teleoperation_spot/cpp/ORB_SLAM3
ls -lh lib/libORB_SLAM3.so
# -rwxrwxr-x 1 rysch01 rysch01 5.0M Dec  3 16:42 libORB_SLAM3.so

ldd lib/libORB_SLAM3.so | grep g2o
# Thirdparty/g2o/lib/libg2o.so is found
```

Vocabulary is present and valid:

```bash
cd ~/Projects/teleoperation_spot/cpp/ORB_SLAM3/Vocabulary
ls -lh ORBvoc.txt
# 139M, downloaded from ORB-SLAM2 repo
```

---

### RGB-D config to use (Xtion A)

Use this file for camA:

```bash
cat ~/Projects/teleoperation_spot/system_ws/src/orbslam3_ros2/config/xtionA_rgbd.yaml
```

Contents (key bits):

```yaml
%YAML:1.0
File.version: "1.0"
Camera.type: "PinHole"

# Xtion A intrinsics (from /camA/rgb/camera_info)
Camera1.fx: 570.3422241210938
Camera1.fy: 570.3422241210938
Camera1.cx: 319.5
Camera1.cy: 239.5

Camera1.k1: 0.0
Camera1.k2: 0.0
Camera1.p1: 0.0
Camera1.p2: 0.0
Camera1.k3: 0.0

Camera.width: 640
Camera.height: 480
Camera.fps: 30
Camera.RGB: 1

Stereo.ThDepth: 40.0
Stereo.b: 0.07732

# depth_raw is in meters -> use 1000 (see below)
RGBD.DepthMapFactor: 1000.0

ORBextractor.nFeatures: 1000
ORBextractor.scaleFactor: 1.2
ORBextractor.nLevels: 8
ORBextractor.iniThFAST: 20
ORBextractor.minThFAST: 7

Viewer.KeyFrameSize: 0.05
Viewer.ViewpointF: 500.0
```

I edited `RGBD.DepthMapFactor` to **1000.0** because `/camA/depth/image` encodes depth in meters * 1000 (checked via echo).

---

### How I run it

With a bag playing:

```bash
cd ~/Projects/teleoperation_spot/system_ws
source /opt/ros/jazzy/setup.bash
source install/setup.bash

# Terminal 1 – play bag (loop)
ros2 bag play xtion_20251203_154457.bag/ --loop

# Terminal 2 – run ORB-SLAM3 RGBD
cd ~/Projects/teleoperation_spot/system_ws
source /opt/ros/jazzy/setup.bash
source install/setup.bash

ros2 run orbslam3 rgbd -- \
  ~/Projects/teleoperation_spot/cpp/ORB_SLAM3/Vocabulary/ORBvoc.txt \
  ~/Projects/teleoperation_spot/system_ws/src/orbslam3_ros2/config/xtionA_rgbd.yaml \
  --ros-args \
  -r /camera/color/image_raw:=/camA/rgb/image_raw \
  -r /camera/aligned_depth_to_color/image_raw:=/camA/depth/image \
  -r /camera/color/camera_info:=/camA/rgb/camera_info
```

---

### Current symptoms

On every run of the RGB-D node I see:

```text
ORB-SLAM3 Copyright ...
Input sensor was set to: RGB-D
Loading settings from .../xtionA_rgbd.yaml
  -Loaded camera 1
  -Loaded image info
  -Loaded RGB-D calibration
  -Loaded ORB settings
  -Loaded viewer settings
  -Loaded Atlas settings
  -Loaded misc parameters
----------------------------------
SLAM settings:
  Camera 1 parameters (Pinhole): [ 570.342 570.342 319.5 239.5 ]
  Camera 1 distortion parameters: [  0 0 0 0 0 ]
  Original image size: [ 640 , 480 ]
  Current image size: [ 640 , 480 ]
  Sequence FPS: 30
  RGB-D depth map factor: 1000
  ...

Loading ORB Vocabulary. This could take a while...
Vocabulary loaded!

Initialization of Atlas from scratch
Creation of new map with id: 0
Creation of new map with last KF id: 0
Seq. Name:
There are 1 cameras in the atlas
Camera 0 is pinhole
double free or corruption (out)
[ros2run]: Aborted
```

Behavior:

* Pangolin window *sometimes* flashes open then closes immediately.
* `KeyFrameTrajectory.txt` is **zero-length** or not written (depending on whether SaveKeyFrameTrajectoryTUM was commented).
* Crash happens **immediately after** “Camera 0 is pinhole”, before any tracking output.

So we’re failing very early, during init or first frame / viewer setup.

---

### What I changed in `orbslam3_ros2` (build fixes that should stay)

All these are already applied and are **needed** for Jazzy:

1. Switched `-std=c++11` → `-std=c++14` across the wrapper.

2. Replaced `monotonic_clock` with `steady_clock`.

3. Patched `CMakeModules/FindORB_SLAM3.cmake` to:

   ```cmake
   set(ORB_SLAM3_ROOT_DIR "/home/rysch01/Projects/teleoperation_spot/cpp/ORB_SLAM3")
   ```

4. Updated includes to `cv_bridge/cv_bridge.hpp`.

5. Added OpenCV + Pangolin include directories in `CMakeLists.txt`.

6. Ensured `ament_target_dependencies` includes `cv_bridge`, `OpenCV`, `Pangolin`, `ORB_SLAM3` where appropriate.

7. Added `target_link_libraries(... ${OpenCV_LIBRARIES})` for all four executables.

8. Added Sophus include dir: `${ORB_SLAM3_ROOT_DIR}/Thirdparty/Sophus`.

---

### Runtime-related code that **is now restored to normal**

I previously experimented with:

* Commenting out `SaveKeyFrameTrajectoryTUM("KeyFrameTrajectory.txt")`.
* Commenting out `m_SLAM->Shutdown()` in the wrappers.
* Changing `ORB_SLAM3::System::RGBD, true)` to `false`.

As of now:

```bash
# trajectory saving is ON
grep -n "SaveKeyFrameTrajectoryTUM" src/orbslam3_ros2/src/*/*-slam-node.cpp
src/orbslam3_ros2/src/monocular/monocular-slam-node.cpp:25:m_SLAM->SaveKeyFrameTrajectoryTUM("KeyFrameTrajectory.txt");
src/orbslam3_ros2/src/rgbd/rgbd-slam-node.cpp:25:m_SLAM->SaveKeyFrameTrajectoryTUM("KeyFrameTrajectory.txt");
src/orbslam3_ros2/src/stereo/stereo-slam-node.cpp:64:m_SLAM->SaveKeyFrameTrajectoryTUM("KeyFrameTrajectory.txt");

# Shutdown calls:
grep -R "Shutdown();" -n src/orbslam3_ros2
src/orbslam3_ros2/src/stereo-inertial/stereo-inertial-node.cpp:74:    SLAM_->Shutdown();
src/orbslam3_ros2/src/rgbd/rgbd-slam-node.cpp:22:    m_SLAM->Shutdown();   # ← restored
src/orbslam3_ros2/src/monocular/monocular-slam-node.cpp:22:    m_SLAM->Shutdown();
src/orbslam3_ros2/src/stereo/stereo-slam-node.cpp:61:    m_SLAM->Shutdown();

# RGBD System construction:
grep -R "System::RGBD" -n src/orbslam3_ros2
src/orbslam3_ros2/src/rgbd/rgbd.cpp:25:    ORB_SLAM3::System SLAM(argv[1], argv[2], ORB_SLAM3::System::RGBD, visualization);
```

So the wrappers are back to “normal” behavior (shutdown + trajectory save) with the **only differences vs upstream being CMake / includes**.

---

### What I’d like you (Claude) to do

1. **Initialize a git repo** at the project root and capture the current state:

   ```bash
   cd ~/Projects/teleoperation_spot

   git init
   git add -A
   git commit -m "Initial full snapshot including ORB_SLAM3 core, ROS2 wrappers, Xtion bringup"
   ```

   You can then add a `.gitignore` with at least:

   ```gitignore
   # ROS2 build / install / logs
   system_ws/build/
   system_ws/install/
   system_ws/log/

   # CMake build dirs elsewhere
   cpp/**/build/
   cpp/**/CMakeFiles/
   cpp/**/CMakeCache.txt

   # Bag files
   *.db3
   *.bag
   xtion_20*.bag/

   # Editor/OS
   .vscode/
   .idea/
   *~
   .DS_Store
   ```

2. **Debug the double free / corruption**, with all sed experiments essentially “normalized” already:

   * Run `ros2 run orbslam3 rgbd ...` under `gdb`, get a full backtrace.
   * Check Pangolin viewer initialization and shutdown paths.
   * Check destructor / ownership patterns for Atlas, Map, Viewer.
   * Confirm `libORB_SLAM3.so` and the ROS2 nodes all use the same `libstdc++`.
   * If helpful, compare `orbslam3_ros2` to its upstream repo and isolate diffs.

3. Please **copy all terminal I/O** you use during debugging into a note (or even into `docs/setup/9_orbslam3_debug_log`), so I can replay/understand your steps later.

The config you should focus on is:

* `xtionA_rgbd.yaml` (current and correct)
* `xtionB_rgbd.yaml` is still the older, hand-written version and should be updated *after* the RGB-D path is stable.
4. While you’re debugging, please:

   * Store all terminal I/O and edits (including `sed` commands, git diffs, etc.)
     in a text file:
       `~/Projects/teleoperation_spot/docs/setup/9_orbslam3_w_xtion_rosbags_repair`
   * Before making any non-trivial code/config changes (e.g., changing `RGBD.DepthMapFactor`,
     camera intrinsics, or disabling features like Shutdown/trajectory saving), ask me first
     so we can keep behavior aligned with the downstream multi-camera pipeline.